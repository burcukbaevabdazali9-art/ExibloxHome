<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>ExiWin 12</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;user-select:none;}
:root{
  --accent:#0078d4;--accent2:#60cdff;
  --bg1:rgba(15,20,35,0.95);--bg2:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.10);--text:#fff;--text2:rgba(255,255,255,0.55);
  --radius:12px;--shadow:0 12px 48px rgba(0,0,0,0.55);--blur:blur(40px);
  --desktop-bg:linear-gradient(160deg,#040c1a 0%,#061020 40%,#040c18 100%);
  --taskbar-bg:rgba(8,12,22,.92);--menu-bg:rgba(12,16,28,.97);
  --card-bg:rgba(255,255,255,.04);--input-bg:rgba(255,255,255,.07);
}
body.light-theme{
  --bg1:rgba(250,252,255,0.97);--bg2:rgba(0,0,0,0.04);
  --border:rgba(0,0,0,0.10);--text:#111;--text2:rgba(0,0,0,0.55);
  --shadow:0 8px 28px rgba(0,0,0,0.12);
  --desktop-bg:linear-gradient(160deg,#dceeff 0%,#eef4fb 40%,#d8eaf5 100%);
  --taskbar-bg:rgba(245,249,255,.96);--menu-bg:rgba(255,255,255,.99);
  --card-bg:rgba(0,0,0,.03);--input-bg:rgba(0,0,0,.05);
}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#000;overflow:hidden;width:100vw;height:100vh;color:var(--text);}
#rainbow-cursor-canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;pointer-events:none;z-index:999999;}
#boot{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;transition:opacity .5s;}
.boot-logo{font-size:76px;font-weight:800;margin-bottom:48px;background:linear-gradient(135deg,#0078d4,#60cdff,#0078d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:logoPulse 2s ease-in-out infinite;}
@keyframes logoPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.3)}}
.boot-bar{width:200px;height:3px;background:rgba(255,255,255,.1);border-radius:2px;overflow:hidden;}
.boot-fill{height:100%;background:linear-gradient(90deg,#0078d4,#60cdff);border-radius:2px;animation:bootFill 2.2s ease forwards;}
@keyframes bootFill{0%{width:0}60%{width:70%}100%{width:100%}}
.boot-txt{color:rgba(255,255,255,.3);font-size:12px;margin-top:16px;letter-spacing:2px;}
#regscreen{position:fixed;inset:0;z-index:9990;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg,#040e1f 0%,#091428 100%);}
.reg-box{background:rgba(255,255,255,.05);backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:40px;width:420px;box-shadow:var(--shadow);text-align:center;}
.reg-logo{font-size:44px;font-weight:800;background:linear-gradient(135deg,#0078d4,#60cdff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:12px;}
.reg-box h2{font-size:24px;font-weight:300;margin-bottom:6px;color:#fff;}
.reg-box p{color:rgba(255,255,255,.5);font-size:13px;margin-bottom:26px;}
.reg-avatar-pick{display:flex;gap:10px;justify-content:center;margin-bottom:22px;flex-wrap:wrap;}
.av-opt{width:46px;height:46px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:22px;border:3px solid transparent;transition:all .2s;background:rgba(255,255,255,.06);}
.av-opt.sel{border-color:#60cdff;transform:scale(1.15);}
.reg-input{width:100%;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:11px 14px;color:#fff;font-size:14px;font-family:inherit;outline:none;margin-bottom:10px;transition:border .2s;}
.reg-input:focus{border-color:var(--accent);}
.reg-input::placeholder{color:rgba(255,255,255,.35);}
.reg-btn{width:100%;padding:12px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-size:14px;cursor:pointer;font-family:inherit;font-weight:500;transition:background .2s;margin-top:4px;}
.reg-btn:hover{background:#106ebe;}
.reg-switch{color:rgba(255,255,255,.5);font-size:13px;margin-top:14px;cursor:pointer;}
.reg-switch span{color:var(--accent2);}
.reg-err{color:#ff6b6b;font-size:12px;margin-top:8px;min-height:18px;}
#lockscreen{position:fixed;inset:0;z-index:9980;display:none;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;background:linear-gradient(160deg,#040c1a 0%,#081428 100%);}
.lock-glow{position:absolute;width:600px;height:600px;border-radius:50%;background:radial-gradient(circle,rgba(0,120,212,.12) 0%,transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;animation:glowPulse 4s ease-in-out infinite;}
@keyframes glowPulse{0%,100%{opacity:.6;transform:translate(-50%,-50%) scale(1)}50%{opacity:1;transform:translate(-50%,-50%) scale(1.1)}}
#lock-clock{font-size:88px;font-weight:200;letter-spacing:6px;color:#fff;text-shadow:0 0 40px rgba(0,120,212,.3);}
#lock-date-lock{font-size:18px;color:rgba(255,255,255,.55);margin-bottom:48px;}
.lock-user{display:flex;flex-direction:column;align-items:center;gap:12px;}
#lock-avatar{width:72px;height:72px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;box-shadow:0 0 0 3px rgba(255,255,255,.2);}
#lock-username-disp{font-size:18px;color:#fff;}
.lock-hint{font-size:13px;color:rgba(255,255,255,.3);margin-top:18px;animation:pulse 2s ease infinite;}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:.8}}
#desktop{width:100%;height:calc(100% - 48px);position:relative;overflow:hidden;background:var(--desktop-bg);}
.desk-aurora{position:absolute;inset:0;pointer-events:none;background:conic-gradient(from 200deg at 30% 60%,transparent 0deg,rgba(0,80,180,.06) 60deg,rgba(0,150,255,.08) 100deg,rgba(60,0,180,.05) 150deg,transparent 200deg);animation:auroraRot 20s linear infinite;}
@keyframes auroraRot{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.desk-glow{position:absolute;width:700px;height:500px;border-radius:50%;background:radial-gradient(ellipse,rgba(0,100,200,.08) 0%,transparent 70%);top:20%;left:30%;pointer-events:none;}
body.light-theme .desk-aurora{background:conic-gradient(from 200deg at 30% 60%,transparent 0deg,rgba(0,120,212,.03) 60deg,rgba(0,150,255,.05) 100deg,rgba(100,80,255,.03) 150deg,transparent 200deg);}
.desk-icon{position:absolute;display:flex;flex-direction:column;align-items:center;gap:6px;padding:8px 6px;width:82px;cursor:pointer;border-radius:10px;transition:background .15s;}
.desk-icon:hover{background:rgba(255,255,255,.09);}
body.light-theme .desk-icon:hover{background:rgba(0,0,0,.07);}
.desk-icon.selected{background:rgba(0,120,212,.3);}
.desk-icon.dragging-icon{opacity:.7;z-index:9000;cursor:grabbing;transition:none;}
.desk-icon .dico{font-size:36px;line-height:1;filter:drop-shadow(0 3px 8px rgba(0,0,0,.5));pointer-events:none;}
body.light-theme .desk-icon .dico{filter:drop-shadow(0 2px 4px rgba(0,0,0,.2));}
.desk-icon span{font-size:11px;color:#fff;text-align:center;text-shadow:0 1px 6px rgba(0,0,0,.9);line-height:1.3;word-break:break-word;pointer-events:none;}
body.light-theme .desk-icon span{color:var(--text);text-shadow:0 1px 3px rgba(255,255,255,.8);}
#taskbar{position:fixed;bottom:0;left:0;right:0;height:48px;background:var(--taskbar-bg);backdrop-filter:var(--blur);border-top:1px solid var(--border);display:flex;align-items:center;z-index:1000;}
#tb-left{display:flex;align-items:center;padding-left:8px;gap:2px;}
#tb-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:2px;}
#tb-right{position:absolute;right:0;display:flex;align-items:center;padding-right:8px;gap:4px;}
#start-btn{width:44px;height:38px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:22px;font-weight:800;transition:background .15s;background:linear-gradient(135deg,#0078d4,#60cdff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
#start-btn:hover{background:rgba(255,255,255,.1);-webkit-text-fill-color:var(--text);}
.tb-sep{width:1px;height:22px;background:var(--border);margin:0 4px;}
.tb-btn{width:44px;height:38px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:19px;transition:background .15s;position:relative;flex-shrink:0;}
.tb-btn:hover{background:rgba(255,255,255,.09);}
body.light-theme .tb-btn:hover{background:rgba(0,0,0,.07);}
.tb-btn.running::after{content:'';position:absolute;bottom:3px;left:50%;transform:translateX(-50%);width:4px;height:4px;border-radius:50%;background:var(--accent2);}
.tb-btn.active-win{background:rgba(255,255,255,.12);}
body.light-theme .tb-btn.active-win{background:rgba(0,0,0,.10);}
.tb-sys{display:flex;align-items:center;gap:5px;font-size:13px;cursor:pointer;padding:4px 8px;border-radius:8px;transition:background .15s;}
.tb-sys:hover{background:rgba(255,255,255,.09);}
body.light-theme .tb-sys:hover{background:rgba(0,0,0,.07);}
#tb-clock{color:var(--text);font-size:11.5px;text-align:right;cursor:pointer;line-height:1.5;padding:0 4px;}
#start-menu{position:fixed;bottom:56px;left:50%;transform:translateX(-50%) translateY(8px);width:680px;background:var(--menu-bg);backdrop-filter:var(--blur);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);display:none;flex-direction:column;z-index:900;overflow:hidden;opacity:0;transition:opacity .18s,transform .18s;}
#start-menu.show{opacity:1;transform:translateX(-50%) translateY(0);}
#sm-search{margin:16px 16px 0;display:flex;align-items:center;background:var(--input-bg);border:1px solid var(--border);border-radius:10px;padding:9px 14px;gap:10px;}
#sm-search input{background:none;border:none;outline:none;color:var(--text);font-size:13px;flex:1;font-family:inherit;}
#sm-search input::placeholder{color:var(--text2);}
.sm-sec{padding:12px 16px 6px;font-size:11px;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;}
.pinned-apps{display:grid;grid-template-columns:repeat(6,1fr);gap:2px;padding:0 8px;}
.pin-app{display:flex;flex-direction:column;align-items:center;gap:5px;padding:12px 6px 8px;border-radius:10px;cursor:pointer;transition:background .15s;}
.pin-app:hover{background:var(--bg2);}
.pin-app .ico{font-size:24px;}
.pin-app .lbl{font-size:10.5px;color:var(--text2);text-align:center;}
.rec-list{padding:0 10px;display:flex;flex-direction:column;gap:1px;}
.rec-row{display:flex;align-items:center;gap:12px;padding:8px 10px;border-radius:8px;cursor:pointer;transition:background .15s;}
.rec-row:hover{background:var(--bg2);}
.rec-row .ico{font-size:20px;}
.rec-info .n{font-size:13px;color:var(--text);}
.rec-info .t{font-size:11px;color:var(--text2);}
#sm-search-results{padding:0 10px;}
#sm-footer{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;border-top:1px solid var(--border);}
#sm-user{display:flex;align-items:center;gap:10px;cursor:pointer;padding:6px 10px;border-radius:8px;transition:background .15s;}
#sm-user:hover{background:var(--bg2);}
#sm-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;}
#sm-username{font-size:13px;color:var(--text);}
.power-menu{display:flex;gap:3px;}
.pw-btn{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;transition:background .15s;color:var(--text2);}
.pw-btn:hover{background:rgba(196,43,28,.7);color:#fff;}
#tray-popup{position:fixed;bottom:56px;right:8px;width:380px;background:var(--menu-bg);backdrop-filter:var(--blur);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:var(--shadow);display:none;z-index:900;}
.tray-time-big{font-size:50px;font-weight:200;text-align:center;letter-spacing:2px;color:var(--text);}
.tray-date-str{font-size:12px;color:var(--text2);text-align:center;margin-bottom:14px;}
.tray-tiles{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;margin-bottom:12px;}
.tr-tile{background:rgba(0,120,212,.25);border-radius:10px;padding:10px 8px 7px;cursor:pointer;transition:all .15s;display:flex;flex-direction:column;gap:3px;}
.tr-tile:hover{background:rgba(0,120,212,.4);}
.tr-tile.off{background:var(--bg2);}
.tr-tile .ico{font-size:16px;}
.tr-tile .lbl{font-size:10px;color:var(--text2);}
.sl-row{display:flex;align-items:center;gap:10px;margin:5px 0;}
.sl-row .ico{font-size:15px;flex-shrink:0;}
.sl-row input[type=range]{flex:1;accent-color:var(--accent);height:4px;}
.sl-val{font-size:11px;color:var(--text2);width:32px;text-align:right;}
#wallpaper-gallery{position:fixed;bottom:56px;right:8px;width:520px;background:var(--menu-bg);backdrop-filter:var(--blur);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:var(--shadow);z-index:9500;display:none;animation:wpGalleryIn .2s ease;}
@keyframes wpGalleryIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.wp-gallery-title{font-size:15px;font-weight:500;color:var(--text);margin-bottom:4px;display:flex;align-items:center;justify-content:space-between;}
.wp-gallery-sub{font-size:11px;color:var(--text2);margin-bottom:14px;}
.wp-gallery-close{cursor:pointer;color:var(--text2);font-size:18px;padding:2px 6px;border-radius:6px;transition:background .12s;}
.wp-gallery-close:hover{background:rgba(196,43,28,.7);color:#fff;}
.wp-tabs{display:flex;gap:6px;margin-bottom:12px;}
.wp-tab{padding:5px 14px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--border);color:var(--text2);transition:all .15s;}
.wp-tab.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.wp-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:360px;overflow-y:auto;}
.wp-item{aspect-ratio:16/9;border-radius:10px;cursor:pointer;position:relative;overflow:hidden;border:2px solid transparent;transition:all .18s;}
.wp-item:hover{transform:scale(1.04);border-color:rgba(255,255,255,.3);}
.wp-item.wp-active{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent);}
.wp-item-label{position:absolute;bottom:0;left:0;right:0;padding:4px 6px;font-size:9px;color:#fff;background:linear-gradient(transparent,rgba(0,0,0,.6));text-align:center;opacity:0;transition:opacity .15s;border-radius:0 0 8px 8px;}
.wp-item:hover .wp-item-label{opacity:1;}
.wp-default-badge{position:absolute;top:4px;right:4px;font-size:9px;background:rgba(0,120,212,.85);color:#fff;padding:2px 5px;border-radius:8px;}
#ctx-menu{position:fixed;z-index:9998;background:var(--menu-bg);backdrop-filter:var(--blur);border:1px solid var(--border);border-radius:var(--radius);padding:5px;min-width:210px;box-shadow:var(--shadow);display:none;}
.ctx-item{padding:8px 12px;border-radius:8px;font-size:13px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:10px;transition:background .1s;position:relative;}
.ctx-item:hover{background:var(--bg2);}
.ctx-sep{height:1px;background:var(--border);margin:3px 2px;}
#ctx-create-sub{position:fixed;z-index:9999;background:var(--menu-bg);backdrop-filter:var(--blur);border:1px solid var(--border);border-radius:var(--radius);padding:5px;min-width:200px;box-shadow:var(--shadow);display:none;}
.exp-view-btn{width:26px;height:22px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:12px;cursor:pointer;color:var(--text2);transition:background .12s;}
.exp-view-btn:hover{background:var(--bg2);}
.exp-view-btn.active-view{background:rgba(0,120,212,.35);color:var(--text);}
.window{position:absolute;background:var(--bg1);backdrop-filter:var(--blur);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);display:none;flex-direction:column;min-width:320px;min-height:200px;z-index:100;animation:winOpen .14s ease;}
@keyframes winOpen{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
@keyframes winClose{from{opacity:1;transform:scale(1)}to{opacity:0;transform:scale(.95)}}
.window.maximized{border-radius:0!important;top:0!important;left:0!important;width:100%!important;height:calc(100vh - 48px)!important;}
.titlebar{height:40px;display:flex;align-items:center;padding:0 10px;cursor:move;border-radius:var(--radius) var(--radius) 0 0;flex-shrink:0;background:var(--bg2);border-bottom:1px solid var(--border);}
.tb-icon{font-size:15px;margin-right:8px;}
.tb-title{flex:1;font-size:13px;color:var(--text);}
.win-btns{display:flex;gap:2px;}
.wb{width:30px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;color:var(--text2);transition:background .12s;}
.wb:hover{background:var(--bg2);color:var(--text);}
.wb.cls:hover{background:rgba(196,43,28,.85);color:#fff;}
.win-body{flex:1;overflow:auto;border-radius:0 0 var(--radius) var(--radius);}
.resize-handle{position:absolute;width:14px;height:14px;bottom:0;right:0;cursor:se-resize;}
.exp-wrap{display:flex;flex-direction:column;height:100%;}
.exp-topbar{display:flex;align-items:center;gap:6px;padding:5px 8px;border-bottom:1px solid var(--border);flex-shrink:0;}
.exp-nav{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:14px;transition:background .12s;}
.exp-nav:hover{background:var(--bg2);}
.exp-path{flex:1;background:var(--input-bg);border:1px solid var(--border);border-radius:7px;padding:4px 12px;font-size:12px;color:var(--text);cursor:text;outline:none;font-family:inherit;}
.exp-body{display:flex;flex:1;overflow:hidden;}
.exp-side{width:170px;border-right:1px solid var(--border);padding:8px;overflow-y:auto;flex-shrink:0;background:rgba(0,0,0,.1);}
.exp-side-item{padding:6px 10px;border-radius:7px;font-size:12px;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .12px;}
.exp-side-item:hover{background:var(--bg2);}
.exp-side-item.active{background:rgba(0,120,212,.3);color:var(--text);}
.exp-files{flex:1;padding:10px;display:grid;grid-template-columns:repeat(auto-fill,88px);gap:6px;align-content:start;overflow-y:auto;}
.file-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 5px;border-radius:8px;cursor:pointer;transition:background .12px;}
.file-item:hover{background:var(--bg2);}
.file-item .ico{font-size:32px;}
.file-item .fname{font-size:10.5px;color:var(--text2);text-align:center;word-break:break-all;}
.exp-statusbar{padding:3px 14px;font-size:11px;color:var(--text2);border-top:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.np-wrap{display:flex;flex-direction:column;height:100%;}
.np-menubar{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.np-menu-item{padding:5px 12px;font-size:13px;color:var(--text2);cursor:pointer;transition:background .12px;position:relative;}
.np-menu-item:hover,.np-menu-item.open{background:var(--bg2);color:var(--text);}
.np-dropdown{position:absolute;top:100%;left:0;background:var(--menu-bg);border:1px solid var(--border);border-radius:8px;padding:4px;min-width:160px;z-index:9999;display:none;box-shadow:var(--shadow);}
.np-menu-item.open .np-dropdown{display:block;}
.np-dd-item{padding:6px 12px;border-radius:6px;font-size:13px;color:var(--text);cursor:pointer;display:flex;justify-content:space-between;align-items:center;}
.np-dd-item:hover{background:var(--bg2);}
.np-dd-item kbd{font-size:10px;color:var(--text2);background:var(--bg2);padding:1px 5px;border-radius:4px;}
.np-dd-sep{height:1px;background:var(--border);margin:3px 0;}
#np-area{flex:1;background:var(--input-bg);color:var(--text);border:none;outline:none;padding:14px;font-size:14px;font-family:'Consolas',monospace;resize:none;line-height:1.7;user-select:text;}
.np-statusbar{display:flex;gap:16px;padding:3px 10px;font-size:11px;color:var(--text2);border-top:1px solid var(--border);flex-shrink:0;}
.calc-wrap{padding:12px;display:flex;flex-direction:column;gap:8px;height:100%;}
.calc-modes{display:flex;gap:2px;margin-bottom:2px;}
.calc-mode-btn{padding:4px 10px;border-radius:6px;font-size:11px;color:var(--text2);cursor:pointer;transition:background .12px;}
.calc-mode-btn:hover,.calc-mode-btn.active{background:var(--bg2);color:var(--text);}
.calc-display{background:var(--input-bg);border-radius:10px;padding:10px 14px;display:flex;flex-direction:column;align-items:flex-end;}
.calc-expr{font-size:12px;color:var(--text2);min-height:18px;word-break:break-all;}
.calc-result{font-size:36px;font-weight:300;min-height:48px;word-break:break-all;color:var(--text);}
.calc-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;flex:1;}
.calc-sci{display:none;grid-template-columns:repeat(5,1fr);gap:6px;}
.cc{border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:all .1s;color:var(--text);min-height:44px;}
.cc:hover{filter:brightness(1.2);}
.cc:active{transform:scale(.93);}
.cc-fn{background:var(--bg2);color:var(--text2);}
.cc-op{background:rgba(0,120,212,.3);}
.cc-eq{background:var(--accent);color:#fff;}
.cc-num{background:var(--card-bg);}
.cc-sci-btn{background:rgba(96,205,255,.15);color:var(--accent2);font-size:12px;}
.set-wrap{display:flex;height:100%;}
.set-side{width:200px;border-right:1px solid var(--border);padding:8px;overflow-y:auto;background:rgba(0,0,0,.1);flex-shrink:0;}
.set-side-item{padding:9px 12px;border-radius:8px;font-size:12px;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .12px;}
.set-side-item:hover{background:var(--bg2);}
.set-side-item.active{background:rgba(0,120,212,.3);color:var(--text);}
.set-content{flex:1;padding:22px;overflow-y:auto;}
.set-page{display:none;}
.set-page.active{display:block;}
.set-h1{font-size:20px;font-weight:300;margin-bottom:18px;color:var(--text);}
.set-card{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:7px;display:flex;align-items:center;justify-content:space-between;gap:14px;}
.set-card-l .n{font-size:13px;color:var(--text);}
.set-card-l .d{font-size:11px;color:var(--text2);margin-top:2px;}
.toggle{width:42px;height:22px;border-radius:11px;background:var(--bg2);position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:'';position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;top:3px;left:3px;transition:transform .2s;}
.toggle.on::after{transform:translateX(20px);}
.set-select{background:var(--input-bg);border:1px solid var(--border);border-radius:7px;padding:5px 9px;color:var(--text);font-size:12px;outline:none;font-family:inherit;cursor:pointer;}
.set-range-wrap{display:flex;align-items:center;gap:8px;margin-top:6px;}
.set-range-wrap input{flex:1;accent-color:var(--accent);}
.br-wrap{display:flex;flex-direction:column;height:100%;}
.br-bar{display:flex;align-items:center;gap:5px;padding:6px 8px;border-bottom:1px solid var(--border);flex-shrink:0;}
.br-nav{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);font-size:14px;transition:background .12px;}
.br-nav:hover{background:var(--bg2);}
.br-url-bar{flex:1;background:var(--input-bg);border:1px solid var(--border);border-radius:18px;padding:5px 14px;font-size:12px;color:var(--text);outline:none;font-family:inherit;}
#br-newtab{flex:1;padding:28px 20px;display:flex;flex-direction:column;align-items:center;gap:18px;overflow-y:auto;}
.br-greeting{font-size:24px;font-weight:300;color:var(--text);}
.br-searchbar{display:flex;align-items:center;background:var(--input-bg);border:1px solid var(--border);border-radius:24px;padding:9px 18px;gap:10px;width:520px;max-width:100%;}
.br-searchbar input{background:none;border:none;outline:none;color:var(--text);font-size:14px;flex:1;font-family:inherit;}
.br-searchbar button{background:var(--accent);border:none;color:#fff;padding:6px 16px;border-radius:16px;cursor:pointer;font-size:12px;font-family:inherit;}
.br-shortcuts{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:520px;max-width:100%;}
.br-sc{background:var(--card-bg);border-radius:12px;padding:12px 8px;display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;transition:background .12px;}
.br-sc:hover{background:var(--bg2);}
.br-sc .ico{font-size:20px;}
.br-sc span{font-size:10.5px;color:var(--text2);}
#br-frame{flex:1;width:100%;border:none;display:none;background:#fff;}
.paint-wrap{display:flex;flex-direction:column;height:100%;}
.paint-toolbar{display:flex;align-items:center;gap:7px;padding:6px 10px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;}
.paint-tool{width:32px;height:32px;border-radius:7px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:background .12px;}
.paint-tool:hover,.paint-tool.active{background:rgba(0,120,212,.35);}
.paint-colors{display:flex;gap:4px;flex-wrap:wrap;max-width:160px;}
.paint-color{width:18px;height:18px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:border .12px;}
.paint-color.active{border-color:var(--text);}
.paint-size{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2);}
.paint-size input{width:70px;accent-color:var(--accent);}
.paint-canvas-wrap{flex:1;overflow:hidden;background:#fff;position:relative;}
#paint-canvas{cursor:crosshair;display:block;}
.tm-wrap{display:flex;flex-direction:column;height:100%;}
.tm-tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.tm-tab{padding:10px 16px;font-size:12px;color:var(--text2);cursor:pointer;transition:all .12px;border-bottom:2px solid transparent;}
.tm-tab:hover{color:var(--text);}
.tm-tab.active{color:var(--text);border-bottom-color:var(--accent);}
.tm-body{flex:1;padding:12px;overflow-y:auto;}
.tm-table{width:100%;border-collapse:collapse;font-size:12px;}
.tm-table th{text-align:left;padding:7px 10px;color:var(--text2);font-weight:400;border-bottom:1px solid var(--border);}
.tm-table td{padding:7px 10px;border-bottom:1px solid rgba(255,255,255,.03);color:var(--text);}
.tm-table tr:hover td{background:var(--bg2);}
.tm-bar{height:5px;background:var(--bg2);border-radius:3px;overflow:hidden;display:inline-block;width:60px;vertical-align:middle;margin-right:4px;}
.tm-fill{height:100%;border-radius:3px;background:var(--accent);}
.tm-perf-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.tm-perf-card{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:16px;}
.tm-perf-title{font-size:11px;color:var(--text2);margin-bottom:8px;}
.tm-perf-big{font-size:32px;font-weight:200;color:var(--text);margin-bottom:8px;}
.tm-perf-bar{height:6px;background:var(--bg2);border-radius:3px;overflow:hidden;margin-bottom:6px;}
.tm-perf-info{font-size:11px;color:var(--text2);}
.echat-wrap{display:flex;height:100%;overflow:hidden;background:rgba(8,10,20,.97);}
body.light-theme .echat-wrap{background:rgba(246,248,255,.98);}
.echat-sidebar{width:230px;flex-shrink:0;border-right:1px solid var(--border);display:flex;flex-direction:column;background:rgba(0,0,0,.2);}
body.light-theme .echat-sidebar{background:rgba(0,0,0,.04);}
.echat-sidebar-header{padding:12px 10px 8px;font-size:12px;font-weight:600;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.echat-new-btn{background:var(--accent);color:#fff;border:none;border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;font-family:inherit;transition:background .15px;}
.echat-new-btn:hover{background:#106ebe;}
#exian-sessions-list{flex:1;overflow-y:auto;padding:6px;}
.echat-session{padding:8px 10px;border-radius:8px;cursor:pointer;transition:background .12px;position:relative;margin-bottom:2px;}
.echat-session:hover{background:var(--bg2);}
.echat-session.active{background:rgba(0,120,212,.3);}
.echat-session-t{font-size:12px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;}
.echat-session-d{font-size:10px;color:var(--text2);margin-top:2px;}
.echat-session-del{position:absolute;right:6px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:11px;opacity:0;transition:opacity .15px;cursor:pointer;padding:2px 4px;}
.echat-session:hover .echat-session-del{opacity:1;}
.echat-session-del:hover{color:#e74c3c;}
.echat-sidebar-footer{padding:8px 10px;border-top:1px solid var(--border);}
.echat-clear-btn{font-size:11px;color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:6px;padding:6px 8px;border-radius:6px;transition:background .12px;width:100%;}
.echat-clear-btn:hover{background:rgba(231,76,60,.2);color:#e74c3c;}
.echat-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.echat-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;background:rgba(0,0,0,.15);}
body.light-theme .echat-header{background:rgba(0,0,0,.04);}
.echat-header-ico{font-size:28px;}
.echat-header-info .echat-header-name{font-size:15px;font-weight:600;color:var(--text);}
.echat-header-info .echat-header-status{font-size:11px;color:#2ecc71;display:flex;align-items:center;gap:4px;}
.echat-header-info .echat-header-status::before{content:'';width:6px;height:6px;background:#2ecc71;border-radius:50%;display:inline-block;}
.echat-quick{display:flex;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;background:rgba(0,0,0,.08);}
body.light-theme .echat-quick{background:rgba(0,0,0,.03);}
.echat-quick-btn{padding:5px 12px;border-radius:20px;font-size:11px;background:var(--bg2);border:1px solid var(--border);color:var(--text2);cursor:pointer;transition:all .15px;white-space:nowrap;}
.echat-quick-btn:hover{background:rgba(0,120,212,.3);color:var(--text);border-color:var(--accent);}
#exian-chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;}
.echat-msg{display:flex;gap:10px;align-items:flex-start;}
.echat-user{flex-direction:row-reverse;}
.echat-bot{flex-direction:row;}
.echat-avatar-bot{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,#0078d4,#60cdff);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.echat-bot-wrap{display:flex;flex-direction:column;gap:4px;max-width:75%;}
.echat-bot-name{font-size:11px;color:var(--text2);margin-left:2px;}
.echat-bubble{padding:10px 14px;border-radius:14px;font-size:13px;line-height:1.6;word-break:break-word;user-select:text;}
.echat-bubble-user{background:linear-gradient(135deg,#0078d4,#006cbf);color:#fff;border-radius:14px 14px 4px 14px;max-width:65%;align-self:flex-end;}
.echat-bubble-bot{background:var(--bg2);border:1px solid var(--border);color:var(--text);border-radius:4px 14px 14px 14px;}
body.light-theme .echat-bubble-bot{background:rgba(0,0,0,.05);}
.echat-bubble pre{background:rgba(0,0,0,.3);border-radius:6px;padding:8px;font-size:11px;overflow-x:auto;margin:6px 0;}
body.light-theme .echat-bubble pre{background:rgba(0,0,0,.08);}
.echat-bubble code{font-family:'Consolas',monospace;font-size:11.5px;background:rgba(0,0,0,.25);padding:1px 4px;border-radius:4px;}
body.light-theme .echat-bubble code{background:rgba(0,0,0,.1);}
.echat-time{font-size:10px;color:var(--text2);padding:0 4px;}
.echat-msg-footer{display:flex;align-items:center;gap:8px;}
.echat-action{font-size:13px;cursor:pointer;opacity:0;transition:opacity .2px;}
.echat-bot-wrap:hover .echat-action{opacity:1;}
.echat-action:hover{filter:brightness(1.3);}
@keyframes echatIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.echat-animate{animation:echatIn .25s ease;}
.echat-typing{display:flex;align-items:center;gap:4px;padding:12px 14px;}
.edot{width:7px;height:7px;border-radius:50%;background:var(--text2);display:inline-block;animation:dotBounce 1.2s ease infinite;}
.edot:nth-child(2){animation-delay:.2s;}
.edot:nth-child(3){animation-delay:.4s;}
@keyframes dotBounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
.echat-input-area{padding:12px 16px;border-top:1px solid var(--border);background:rgba(0,0,0,.15);flex-shrink:0;}
body.light-theme .echat-input-area{background:rgba(0,0,0,.04);}
.echat-input-row{display:flex;align-items:flex-end;gap:8px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:8px 8px 8px 14px;transition:border .2px;}
.echat-input-row:focus-within{border-color:var(--accent);}
#exian-chat-input{flex:1;background:none;border:none;outline:none;color:var(--text);font-size:13px;font-family:inherit;resize:none;line-height:1.5;max-height:120px;min-height:20px;overflow-y:auto;user-select:text;}
#exian-chat-input::placeholder{color:var(--text2);}
#exian-send-btn{width:34px;height:34px;border-radius:10px;background:var(--accent);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15px;flex-shrink:0;}
#exian-send-btn:hover{background:#106ebe;transform:scale(1.05);}
.echat-hint{font-size:10px;color:var(--text2);text-align:center;margin-top:6px;}
#notif-stack{position:fixed;bottom:60px;right:12px;z-index:9990;display:flex;flex-direction:column;gap:8px;align-items:flex-end;}
.notif{background:var(--menu-bg);backdrop-filter:var(--blur);border:1px solid var(--border);border-radius:14px;padding:12px 14px;width:310px;box-shadow:var(--shadow);display:flex;gap:10px;align-items:flex-start;animation:notifSlide .3s ease;}
@keyframes notifSlide{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:translateX(0)}}
.notif .nico{font-size:24px;flex-shrink:0;}
.notif-txt .nt{font-size:12.5px;font-weight:600;margin-bottom:2px;color:var(--text);}
.notif-txt .nd{font-size:11.5px;color:var(--text2);}
.notif-close{margin-left:auto;cursor:pointer;color:var(--text2);font-size:14px;padding:2px;}
.notif-close:hover{color:var(--text);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(128,128,128,.25);border-radius:3px;}
</style>
</head>
<body>

<canvas id="rainbow-cursor-canvas"></canvas>

<!-- BOOT -->
<div id="boot">
  <div class="boot-logo">E‚ú¶</div>
  <div class="boot-bar"><div class="boot-fill"></div></div>
  <div class="boot-txt">ExiWin 12</div>
</div>

<!-- REGISTER / LOGIN -->
<div id="regscreen" style="display:none;">
  <div class="reg-box" id="reg-box">
    <div class="reg-logo">E‚ú¶</div>
    <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
    <p>–°–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç ExiWin 12</p>
    <div class="reg-avatar-pick">
      <div class="av-opt sel" data-av="üßë" onclick="pickAv(this)">üßë</div>
      <div class="av-opt" data-av="üë©" onclick="pickAv(this)">üë©</div>
      <div class="av-opt" data-av="üßî" onclick="pickAv(this)">üßî</div>
      <div class="av-opt" data-av="üë®‚Äçüíª" onclick="pickAv(this)">üë®‚Äçüíª</div>
      <div class="av-opt" data-av="ü¶ä" onclick="pickAv(this)">ü¶ä</div>
      <div class="av-opt" data-av="üê±" onclick="pickAv(this)">üê±</div>
      <div class="av-opt" data-av="ü§ñ" onclick="pickAv(this)">ü§ñ</div>
      <div class="av-opt" data-av="üéÆ" onclick="pickAv(this)">üéÆ</div>
    </div>
    <input class="reg-input" type="text" id="reg-name" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" maxlength="20">
    <input class="reg-input" type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)">
    <input class="reg-input" type="password" id="reg-pass2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
    <button class="reg-btn" onclick="doRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    <div class="reg-err" id="reg-err"></div>
    <div class="reg-switch" onclick="showLogin()">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <span>–í–æ–π—Ç–∏</span></div>
  </div>
  <div class="reg-box" id="login-box" style="display:none;">
    <div id="login-avatar" style="font-size:52px;margin-bottom:10px;">üßë</div>
    <h2 id="login-name-disp">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h2>
    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</p>
    <input class="reg-input" type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="reg-btn" onclick="doLogin()">–í–æ–π—Ç–∏</button>
    <div class="reg-err" id="login-err"></div>
    <div class="reg-switch" onclick="showRegister()">–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç? <span>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></div>
  </div>
</div>

<!-- LOCK -->
<div id="lockscreen" style="display:none;">
  <div class="lock-glow"></div>
  <div id="lock-clock">12:00</div>
  <div id="lock-date-lock">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 17 —Ñ–µ–≤—Ä–∞–ª—è</div>
  <div class="lock-user">
    <div id="lock-avatar">üßë</div>
    <div id="lock-username-disp">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
    <div class="lock-hint">üîí –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>
  </div>
</div>

<!-- DESKTOP -->
<div id="desktop" onclick="desktopClick(event)" oncontextmenu="showCtxMenu(event,'desktop')">
  <div class="desk-aurora"></div>
  <div class="desk-glow"></div>
  <div class="desk-icon" style="top:16px;left:18px" ondblclick="openApp('explorer')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üíª</div><span>–≠—Ç–æ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä</span></div>
  <div class="desk-icon" style="top:112px;left:18px" ondblclick="openApp('notepad')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üìù</div><span>–ë–ª–æ–∫–Ω–æ—Ç</span></div>
  <div class="desk-icon" style="top:208px;left:18px" ondblclick="openApp('browser')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üåê</div><span>Edge</span></div>
  <div class="desk-icon" style="top:304px;left:18px" ondblclick="openApp('calc')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üßÆ</div><span>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span></div>
  <div class="desk-icon" style="top:400px;left:18px" ondblclick="openApp('settings')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">‚öôÔ∏è</div><span>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span></div>
  <div class="desk-icon" style="top:16px;left:118px" ondblclick="openApp('paint')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üé®</div><span>Paint</span></div>
  <div class="desk-icon" style="top:112px;left:118px" ondblclick="openApp('taskman')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üìä</div><span>–î–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á</span></div>
  <div class="desk-icon" style="top:208px;left:118px" ondblclick="openApp('exianai')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">ü§ñ</div><span>Exian.AI 3.0</span></div>
  <div class="desk-icon" style="top:304px;left:118px" ondblclick="launchExiblox()" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üêç</div><span>Exiblox v3</span></div>
  <div class="desk-icon" style="top:400px;left:118px" ondblclick="openApp('gta6')" onclick="selectIcon(this)" onmousedown="iconDragStart(event,this)"><div class="dico">üéÆ</div><span>GTA 6</span></div>
</div>

<!-- TASKBAR -->
<div id="taskbar">
  <div id="tb-left">
    <div id="start-btn" onclick="toggleStart(event)" title="–ü—É—Å–∫">E‚ú¶</div>
    <div class="tb-sep"></div>
  </div>
  <div id="tb-center">
    <div class="tb-btn" onclick="toggleStart(event)">üîç</div>
    <div class="tb-btn" id="tb-explorer" onclick="tbClick('explorer')">üìÅ</div>
    <div class="tb-btn" id="tb-browser"  onclick="tbClick('browser')">üåê</div>
    <div class="tb-btn" id="tb-notepad"  onclick="tbClick('notepad')">üìù</div>
    <div class="tb-btn" id="tb-calc"     onclick="tbClick('calc')">üßÆ</div>
    <div class="tb-btn" id="tb-paint"    onclick="tbClick('paint')">üé®</div>
    <div class="tb-btn" id="tb-settings" onclick="tbClick('settings')">‚öôÔ∏è</div>
    <div class="tb-btn" id="tb-taskman"  onclick="tbClick('taskman')">üìä</div>
    <div class="tb-btn" id="tb-exianai"  onclick="tbClick('exianai')">ü§ñ</div>
    <div class="tb-btn" id="tb-gta6"     onclick="tbClick('gta6')">üéÆ</div>
  </div>
  <div id="tb-right">
    <div class="tb-sys" onclick="toggleTray(event)"><span>üì∂</span><span>üîä</span><span>üîã</span></div>
    <div id="tb-clock" onclick="toggleTray(event)"><div id="clock-time">12:00</div><div id="clock-date-tb">17.02.2026</div></div>
    <div style="width:4px"></div>
  </div>
</div>

<!-- START MENU -->
<div id="start-menu" onclick="event.stopPropagation()">
  <div id="sm-search"><span>üîç</span><input type="text" id="sm-search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="smSearch(this.value)"></div>
  <div id="sm-pinned-sec">
    <div class="sm-sec">–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ</div>
    <div class="pinned-apps">
      <div class="pin-app" onclick="openApp('explorer');hideAll()"><div class="ico">üìÅ</div><div class="lbl">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</div></div>
      <div class="pin-app" onclick="openApp('settings');hideAll()"><div class="ico">‚öôÔ∏è</div><div class="lbl">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div></div>
      <div class="pin-app" onclick="openApp('browser');hideAll()"><div class="ico">üåê</div><div class="lbl">Edge</div></div>
      <div class="pin-app" onclick="openApp('notepad');hideAll()"><div class="ico">üìù</div><div class="lbl">–ë–ª–æ–∫–Ω–æ—Ç</div></div>
      <div class="pin-app" onclick="openApp('calc');hideAll()"><div class="ico">üßÆ</div><div class="lbl">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div></div>
      <div class="pin-app" onclick="openApp('paint');hideAll()"><div class="ico">üé®</div><div class="lbl">Paint</div></div>
      <div class="pin-app" onclick="openApp('taskman');hideAll()"><div class="ico">üìä</div><div class="lbl">–î–∏—Å–ø–µ—Ç—á–µ—Ä</div></div>
      <div class="pin-app" onclick="openApp('exianai');hideAll()"><div class="ico">ü§ñ</div><div class="lbl">Exian.AI</div></div>
      <div class="pin-app" onclick="launchExiblox();hideAll()"><div class="ico">üêç</div><div class="lbl">Exiblox v3</div></div>
      <div class="pin-app" onclick="openApp('gta6');hideAll()"><div class="ico">üéÆ</div><div class="lbl">GTA 6</div></div>
      <div class="pin-app" onclick="showNotif('–ú–∞–≥–∞–∑–∏–Ω','–°–∫–æ—Ä–æ!','üõí')"><div class="ico">üõí</div><div class="lbl">–ú–∞–≥–∞–∑–∏–Ω</div></div>
      <div class="pin-app" onclick="showNotif('–ü–æ—á—Ç–∞','–ù–µ—Ç –ø–∏—Å–µ–º','‚úâÔ∏è')"><div class="ico">‚úâÔ∏è</div><div class="lbl">–ü–æ—á—Ç–∞</div></div>
      <div class="pin-app" onclick="showNotif('–§–æ—Ç–æ','–ù–µ—Ç —Ñ–æ—Ç–æ','üñºÔ∏è')"><div class="ico">üñºÔ∏è</div><div class="lbl">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div></div>
    </div>
  </div>
  <div class="sm-sec">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ</div>
  <div class="rec-list" id="sm-rec-list">
    <div class="rec-row" onclick="openApp('gta6');hideAll()"><div class="ico">üéÆ</div><div class="rec-info"><div class="n">GTA 6 ‚Äî ExiWin City</div><div class="t">–¢–æ–ª—å–∫–æ —á—Ç–æ</div></div></div>
    <div class="rec-row" onclick="openApp('exianai');hideAll()"><div class="ico">ü§ñ</div><div class="rec-info"><div class="n">Exian.AI ‚Äî –£–º–Ω—ã–π —á–∞—Ç</div><div class="t">–í—á–µ—Ä–∞</div></div></div>
    <div class="rec-row" onclick="openApp('notepad');hideAll()"><div class="ico">üìù</div><div class="rec-info"><div class="n">–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</div><div class="t">2 –¥–Ω—è –Ω–∞–∑–∞–¥</div></div></div>
  </div>
  <div id="sm-search-results"></div>
  <div id="sm-footer">
    <div id="sm-user" onclick="openApp('settings');hideAll()"><div id="sm-avatar">üßë</div><span id="sm-username">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span></div>
    <div class="power-menu">
      <div class="pw-btn" onclick="lockScreen()">üîí</div>
      <div class="pw-btn" onclick="reboot()">üîÑ</div>
      <div class="pw-btn" onclick="shutdown()">‚èª</div>
    </div>
  </div>
</div>

<!-- TRAY POPUP -->
<div id="tray-popup" onclick="event.stopPropagation()">
  <div class="tray-time-big" id="tray-time-big">12:00</div>
  <div class="tray-date-str" id="tray-date-str">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 17 —Ñ–µ–≤—Ä–∞–ª—è 2026</div>
  <div class="tray-tiles">
    <div class="tr-tile on"  id="tr-wifi"        onclick="toggleTile('tr-wifi','WiFi')"><div class="ico">üì∂</div><div class="lbl">Wi-Fi</div></div>
    <div class="tr-tile on"  id="tr-bt"          onclick="toggleTile('tr-bt','Bluetooth')"><div class="ico">üîµ</div><div class="lbl">Bluetooth</div></div>
    <div class="tr-tile off" id="tr-airplane"    onclick="toggleTile('tr-airplane','–ê–≤–∏–∞—Ä–µ–∂–∏–º')"><div class="ico">‚úàÔ∏è</div><div class="lbl">–ê–≤–∏–∞—Ä–µ–∂–∏–º</div></div>
    <div class="tr-tile off" id="tr-night"       onclick="toggleNightMode()"><div class="ico">üåô</div><div class="lbl">–ù–æ—á–Ω–æ–π</div></div>
    <div class="tr-tile off" id="tr-light-theme" onclick="openWallpaperGallery('light')"><div class="ico">‚òÄÔ∏è</div><div class="lbl">–°–≤–µ—Ç–ª–∞—è</div></div>
    <div class="tr-tile on"  id="tr-dark-theme"  onclick="openWallpaperGallery('dark')"><div class="ico">üåë</div><div class="lbl">–¢—ë–º–Ω–∞—è</div></div>
    <div class="tr-tile on"  id="tr-sound"       onclick="toggleTile('tr-sound','–ó–≤—É–∫')"><div class="ico">üîä</div><div class="lbl">–ó–≤—É–∫</div></div>
    <div class="tr-tile off" id="tr-focus"       onclick="toggleTile('tr-focus','–§–æ–∫—É—Å')"><div class="ico">üéØ</div><div class="lbl">–§–æ–∫—É—Å</div></div>
  </div>
  <div class="sl-row"><span class="ico">üîÜ</span><input type="range" min="10" max="100" value="85" id="bright-sl" oninput="setBright(this.value)"><span class="sl-val" id="bright-val">85%</span></div>
  <div class="sl-row"><span class="ico">üîä</span><input type="range" min="0" max="100" value="60" id="vol-sl" oninput="setVol(this.value)"><span class="sl-val" id="vol-val">60%</span></div>
</div>

<!-- WALLPAPER GALLERY -->
<div id="wallpaper-gallery" onclick="event.stopPropagation()">
  <div class="wp-gallery-title">
    <span id="wp-gallery-heading">üñºÔ∏è –í—ã–±–æ—Ä –æ–±–æ–µ–≤ ‚Äî –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span>
    <div class="wp-gallery-close" onclick="closeWallpaperGallery()">‚úï</div>
  </div>
  <div class="wp-gallery-sub">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ–Ω —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞. –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.</div>
  <div class="wp-tabs">
    <div class="wp-tab active" id="wp-tab-dark" onclick="wpSwitchTab('dark')">üåë –¢—ë–º–Ω—ã–µ</div>
    <div class="wp-tab" id="wp-tab-light" onclick="wpSwitchTab('light')">‚òÄÔ∏è –°–≤–µ—Ç–ª—ã–µ</div>
  </div>
  <div class="wp-grid" id="wp-grid"></div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu">
  <div class="ctx-item" id="ctx-open-item" onclick="ctxOpenFile()" style="display:none"><span>üìÇ</span>–û—Ç–∫—Ä—ã—Ç—å</div>
  <div class="ctx-item" id="ctx-move-item" onclick="ctxMoveFile()" style="display:none"><span>üì¶</span>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤...</div>
  <div class="ctx-item" id="ctx-delete-item" onclick="ctxDeleteFile()" style="display:none"><span>üóëÔ∏è</span>–£–¥–∞–ª–∏—Ç—å</div>
  <div class="ctx-sep" id="ctx-file-sep" style="display:none"></div>
  <div class="ctx-item" id="ctx-new-file" onclick="ctxNewFile()" style="display:none"><span>üìÑ</span>–ù–æ–≤—ã–π —Ñ–∞–π–ª</div>
  <div class="ctx-item" id="ctx-create-item" onmouseenter="showCreateSub(event)" onclick="showCreateSub(event)" style="display:none">
    <span>‚ú®</span>–°–æ–∑–¥–∞—Ç—å <span style="margin-left:auto;opacity:.6">‚ñ∂</span>
  </div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="ctxRefresh()"><span>üîÉ</span>–û–±–Ω–æ–≤–∏—Ç—å</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="openWallpaperGallery('light');hideAll()"><span>‚òÄÔ∏è</span>–°–≤–µ—Ç–ª—ã–µ –æ–±–æ–∏</div>
  <div class="ctx-item" onclick="openWallpaperGallery('dark');hideAll()"><span>üåë</span>–¢—ë–º–Ω—ã–µ –æ–±–æ–∏</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="openApp('settings');hideAll()"><span>‚öôÔ∏è</span>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
</div>
<div id="ctx-create-sub" onclick="event.stopPropagation()">
  <div class="ctx-item" onclick="ctxCreateFolder()"><span>üìÅ</span>–ü–∞–ø–∫—É</div>
  <div class="ctx-item" onclick="ctxCreateTextDoc()"><span>üìù</span>–¢–µ–∫—Å—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç</div>
  <div class="ctx-item" onclick="ctxCreateFile()"><span>üìÑ</span>–ù–æ–≤—ã–π —Ñ–∞–π–ª</div>
  <div class="ctx-item" onclick="ctxCreateShortcut()"><span>üîó</span>–Ø—Ä–ª—ã–∫</div>
</div>

<!-- EXPLORER -->
<div class="window" id="win-explorer" style="width:780px;height:520px;top:40px;left:60px;" onclick="bringFront('win-explorer')">
  <div class="titlebar" onmousedown="dragWin(event,'win-explorer')">
    <span class="tb-icon">üìÅ</span><span class="tb-title">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫</span>
    <div class="win-btns"><div class="wb" onclick="minimizeWin('explorer')">‚îÄ</div><div class="wb" onclick="toggleMax('win-explorer')">‚¨ú</div><div class="wb cls" onclick="closeWin('explorer')">‚úï</div></div>
  </div>
  <div class="win-body">
    <div class="exp-wrap">
      <div class="exp-topbar">
        <div class="exp-nav">‚óÄ</div><div class="exp-nav">‚ñ∂</div><div class="exp-nav" onclick="expNav('ExiWin')">‚Üë</div>
        <input class="exp-path" id="exp-path" value="ExiWin://–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª">
        <input type="text" class="exp-path" style="max-width:160px" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="expSearch(this.value)">
        <div class="exp-nav" onclick="expNewFolder()">üìÅ+</div>
      </div>
      <div class="exp-body">
        <div class="exp-side">
          <div class="exp-side-item active" data-folder="–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª" onclick="expNav('–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª')">üñ•Ô∏è –†–∞–±–æ—á–∏–π —Å—Ç–æ–ª</div>
          <div class="exp-side-item" data-folder="–î–æ–∫—É–º–µ–Ω—Ç—ã" onclick="expNav('–î–æ–∫—É–º–µ–Ω—Ç—ã')">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</div>
          <div class="exp-side-item" data-folder="–ó–∞–≥—Ä—É–∑–∫–∏" onclick="expNav('–ó–∞–≥—Ä—É–∑–∫–∏')">‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∫–∏</div>
          <div class="exp-side-item" data-folder="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" onclick="expNav('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è')">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
          <div class="exp-side-item" data-folder="–ú—É–∑—ã–∫–∞" onclick="expNav('–ú—É–∑—ã–∫–∞')">üéµ –ú—É–∑—ã–∫–∞</div>
          <div class="exp-side-item" data-folder="ExiWin" onclick="expNav('ExiWin')">üíª ExiWin (C:)</div>
        </div>
        <div class="exp-files" id="exp-files-content" oncontextmenu="showCtxMenu(event,'explorer')"></div>
      </div>
      <div class="exp-statusbar">
        <span id="exp-status">–û–±—ä–µ–∫—Ç–æ–≤: 0</span>
        <div style="display:flex;align-items:center;gap:3px;">
          <div class="exp-view-btn active-view" id="exp-view-large" onclick="setExpView('large')" title="–ö—Ä—É–ø–Ω—ã–µ –∑–Ω–∞—á–∫–∏">‚äû</div>
          <div class="exp-view-btn" id="exp-view-normal" onclick="setExpView('normal')" title="–û–±—ã—á–Ω—ã–µ">‚äü</div>
          <div class="exp-view-btn" id="exp-view-small" onclick="setExpView('small')" title="–ú–µ–ª–∫–∏–µ">‚ò∞</div>
        </div>
      </div>
    </div>
  </div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-explorer')"></div>
</div>

<!-- NOTEPAD -->
<div class="window" id="win-notepad" style="width:680px;height:500px;top:50px;left:80px;" onclick="bringFront('win-notepad')">
  <div class="titlebar" onmousedown="dragWin(event,'win-notepad')">
    <span class="tb-icon">üìù</span><span class="tb-title">–ë–ª–æ–∫–Ω–æ—Ç</span>
    <div class="win-btns"><div class="wb" onclick="minimizeWin('notepad')">‚îÄ</div><div class="wb" onclick="toggleMax('win-notepad')">‚¨ú</div><div class="wb cls" onclick="closeWin('notepad')">‚úï</div></div>
  </div>
  <div class="win-body">
    <div class="np-wrap">
      <div class="np-menubar">
        <div class="np-menu-item" onclick="npToggleMenu(this)">–§–∞–π–ª<div class="np-dropdown"><div class="np-dd-item" onclick="npNew()">–ù–æ–≤—ã–π <kbd>Ctrl+N</kbd></div><div class="np-dd-sep"></div><div class="np-dd-item" onclick="npSave()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å <kbd>Ctrl+S</kbd></div><div class="np-dd-sep"></div><div class="np-dd-item" onclick="closeWin('notepad')">–ó–∞–∫—Ä—ã—Ç—å</div></div></div>
        <div class="np-menu-item" onclick="npToggleMenu(this)">–ü—Ä–∞–≤–∫–∞<div class="np-dropdown"><div class="np-dd-item" onclick="npCopy()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div><div class="np-dd-item" onclick="npSelectAll()">–í—ã–±—Ä–∞—Ç—å –≤—Å—ë</div><div class="np-dd-sep"></div><div class="np-dd-item" onclick="npFind()">–ù–∞–π—Ç–∏</div></div></div>
        <div class="np-menu-item" onclick="npToggleMenu(this)">–í–∏–¥<div class="np-dropdown"><div class="np-dd-item" onclick="npFontUp()">–ë–æ–ª—å—à–µ —à—Ä–∏—Ñ—Ç</div><div class="np-dd-item" onclick="npFontDown()">–ú–µ–Ω—å—à–µ —à—Ä–∏—Ñ—Ç</div><div class="np-dd-sep"></div><div class="np-dd-item" onclick="npWrap()">–ü–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫</div></div></div>
      </div>
      <textarea id="np-area" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç..." oninput="npChanged()" onclick="npUpdateStatus()" onkeyup="npUpdateStatus()" spellcheck="false"></textarea>
      <div class="np-statusbar"><span id="np-status-ln">–°—Ç—Ä–æ–∫: 1 | –°–ª–æ–≤: 0</span><span id="np-status-pos">–°—Ç—Ä 1, –°—Ç–± 1</span><span>UTF-8</span></div>
    </div>
  </div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-notepad')"></div>
</div>

<!-- CALCULATOR -->
<div class="window" id="win-calc" style="width:320px;height:500px;top:50px;left:100px;" onclick="bringFront('win-calc')">
  <div class="titlebar" onmousedown="dragWin(event,'win-calc')">
    <span class="tb-icon">üßÆ</span><span class="tb-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</span>
    <div class="win-btns"><div class="wb" onclick="minimizeWin('calc')">‚îÄ</div><div class="wb" onclick="toggleMax('win-calc')">‚¨ú</div><div class="wb cls" onclick="closeWin('calc')">‚úï</div></div>
  </div>
  <div class="win-body">
    <div class="calc-wrap">
      <div class="calc-modes"><div class="calc-mode-btn active" data-mode="standard" onclick="calcSetMode('standard')">–û–±—ã—á–Ω—ã–π</div><div class="calc-mode-btn" data-mode="scientific" onclick="calcSetMode('scientific')">–ù–∞—É—á–Ω—ã–π</div></div>
      <div class="calc-display"><div class="calc-expr" id="calc-expr"></div><div class="calc-result" id="calc-result">0</div></div>
      <div class="calc-sci" id="calc-sci">
        <div class="cc cc-sci-btn" onclick="calcSci('sin')">sin</div><div class="cc cc-sci-btn" onclick="calcSci('cos')">cos</div><div class="cc cc-sci-btn" onclick="calcSci('tan')">tan</div><div class="cc cc-sci-btn" onclick="calcSci('sqrt')">‚àöx</div><div class="cc cc-sci-btn" onclick="calcSci('log')">log</div>
        <div class="cc cc-sci-btn" onclick="calcSci('ln')">ln</div><div class="cc cc-sci-btn" onclick="calcSci('x2')">x¬≤</div><div class="cc cc-sci-btn" onclick="calcSci('x3')">x¬≥</div><div class="cc cc-sci-btn" onclick="calcSci('1/x')">1/x</div><div class="cc cc-sci-btn" onclick="calcSci('pi')">œÄ</div>
      </div>
      <div class="calc-grid">
        <div class="cc cc-fn" onclick="calcPress('C')">C</div><div class="cc cc-fn" onclick="calcPress('¬±')">¬±</div><div class="cc cc-fn" onclick="calcPress('%')">%</div><div class="cc cc-op" onclick="calcPress('√∑')">√∑</div>
        <div class="cc cc-num" onclick="calcPress('7')">7</div><div class="cc cc-num" onclick="calcPress('8')">8</div><div class="cc cc-num" onclick="calcPress('9')">9</div><div class="cc cc-op" onclick="calcPress('√ó')">√ó</div>
        <div class="cc cc-num" onclick="calcPress('4')">4</div><div class="cc cc-num" onclick="calcPress('5')">5</div><div class="cc cc-num" onclick="calcPress('6')">6</div><div class="cc cc-op" onclick="calcPress('-')">‚àí</div>
        <div class="cc cc-num" onclick="calcPress('1')">1</div><div class="cc cc-num" onclick="calcPress('2')">2</div><div class="cc cc-num" onclick="calcPress('3')">3</div><div class="cc cc-op" onclick="calcPress('+')">+</div>
        <div class="cc cc-fn" onclick="calcPress('‚å´')">‚å´</div><div class="cc cc-num" onclick="calcPress('0')">0</div><div class="cc cc-num" onclick="calcPress('.')">.</div><div class="cc cc-eq" onclick="calcPress('=')">=</div>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div class="window" id="win-settings" style="width:720px;height:520px;top:50px;left:80px;" onclick="bringFront('win-settings')">
  <div class="titlebar" onmousedown="dragWin(event,'win-settings')">
    <span class="tb-icon">‚öôÔ∏è</span><span class="tb-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
    <div class="win-btns"><div class="wb" onclick="minimizeWin('settings')">‚îÄ</div><div class="wb" onclick="toggleMax('win-settings')">‚¨ú</div><div class="wb cls" onclick="closeWin('settings')">‚úï</div></div>
  </div>
  <div class="win-body">
    <div class="set-wrap">
      <div class="set-side">
        <div class="set-side-item active" data-page="system" onclick="setPage('system')">üíª –°–∏—Å—Ç–µ–º–∞</div>
        <div class="set-side-item" data-page="display" onclick="setPage('display')">üñ•Ô∏è –≠–∫—Ä–∞–Ω</div>
        <div class="set-side-item" data-page="theme" onclick="setPage('theme')">üé® –¢–µ–º–∞</div>
        <div class="set-side-item" data-page="network" onclick="setPage('network')">üåê –°–µ—Ç—å</div>
        <div class="set-side-item" data-page="sound" onclick="setPage('sound')">üîä –ó–≤—É–∫</div>
        <div class="set-side-item" data-page="account" onclick="setPage('account')">üë§ –ê–∫–∫–∞—É–Ω—Ç</div>
        <div class="set-side-item" data-page="about" onclick="setPage('about')">‚ÑπÔ∏è –û —Å–∏—Å—Ç–µ–º–µ</div>
      </div>
      <div class="set-content">
        <div class="set-page active" id="set-system"><div class="set-h1">–°–∏—Å—Ç–µ–º–∞</div><div class="set-card"><div class="set-card-l"><div class="n">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div><div class="d">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div><div class="set-card"><div class="set-card-l"><div class="n">–ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ ExiWin</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div><div class="set-card"><div class="set-card-l"><div class="n">–†–µ–∂–∏–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div></div>
        <div class="set-page" id="set-display"><div class="set-h1">–≠–∫—Ä–∞–Ω</div><div class="set-card"><div class="set-card-l"><div class="n">–Ø—Ä–∫–æ—Å—Ç—å</div><div class="set-range-wrap"><input type="range" min="10" max="100" value="85" oninput="setBright(this.value)"></div></div></div><div class="set-card"><div class="set-card-l"><div class="n">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</div></div><select class="set-select"><option>1920√ó1080</option><option>2560√ó1440</option></select></div><div class="set-card"><div class="set-card-l"><div class="n">–ù–æ—á–Ω–æ–π —Ä–µ–∂–∏–º</div></div><div class="toggle" onclick="toggleNightMode();this.classList.toggle('on')"></div></div></div>
        <div class="set-page" id="set-theme">
          <div class="set-h1">–¢–µ–º–∞ –∏ –æ–±–æ–∏</div>
          <div class="set-card"><div class="set-card-l"><div class="n">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div></div><div class="toggle on" id="set-dark-t" onclick="toggleDarkTheme();el('set-light-t').classList.remove('on');this.classList.add('on')"></div></div>
          <div class="set-card"><div class="set-card-l"><div class="n">–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</div></div><div class="toggle" id="set-light-t" onclick="toggleLightTheme();el('set-dark-t').classList.remove('on');this.classList.add('on')"></div></div>
          <div class="set-card" style="cursor:pointer" onclick="openWallpaperGallery('dark')"><div class="set-card-l"><div class="n">üåë –í—ã–±—Ä–∞—Ç—å —Ç—ë–º–Ω—ã–µ –æ–±–æ–∏</div><div class="d">16 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ñ–æ–Ω–æ–≤</div></div><span style="color:var(--text2)">‚ñ∂</span></div>
          <div class="set-card" style="cursor:pointer" onclick="openWallpaperGallery('light')"><div class="set-card-l"><div class="n">‚òÄÔ∏è –í—ã–±—Ä–∞—Ç—å —Å–≤–µ—Ç–ª—ã–µ –æ–±–æ–∏</div><div class="d">16 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Ñ–æ–Ω–æ–≤</div></div><span style="color:var(--text2)">‚ñ∂</span></div>
        </div>
        <div class="set-page" id="set-network"><div class="set-h1">–°–µ—Ç—å</div><div class="set-card"><div class="set-card-l"><div class="n">Wi-Fi</div><div class="d">ExiWin-Network</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div><div class="set-card"><div class="set-card-l"><div class="n">Bluetooth</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div></div>
        <div class="set-page" id="set-sound"><div class="set-h1">–ó–≤—É–∫</div><div class="set-card"><div class="set-card-l"><div class="n">–ì—Ä–æ–º–∫–æ—Å—Ç—å</div><div class="set-range-wrap"><input type="range" min="0" max="100" value="60" oninput="setVol(this.value)"></div></div></div><div class="set-card"><div class="set-card-l"><div class="n">–ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div></div>
        <div class="set-page" id="set-account"><div class="set-h1">–ê–∫–∫–∞—É–Ω—Ç</div><div class="set-card"><div class="set-card-l"><div class="n" id="set-uname">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div><div class="d">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä ExiWin</div></div></div><div class="set-card"><div class="set-card-l"><div class="n">–°–±—Ä–æ—Å–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</div><div class="d">–£–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</div></div><div style="color:#e74c3c;cursor:pointer;font-size:13px" onclick="setResetUser()">–°–±—Ä–æ—Å–∏—Ç—å</div></div></div>
        <div class="set-page" id="set-about"><div class="set-h1">–û —Å–∏—Å—Ç–µ–º–µ</div><div class="set-card"><div class="set-card-l"><div class="n">ExiWin 12</div><div class="d">–í–µ—Ä—Å–∏—è 24H2 ‚Äî Build 26100</div></div></div><div class="set-card"><div class="set-card-l"><div class="n">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</div><div class="d">Exian Research Labs</div></div></div><div class="set-card"><div class="set-card-l"><div class="n">–¶–ü</div><div class="d">ExiCPU x64 @ 3.6 –ì–ì—Ü</div></div></div><div class="set-card"><div class="set-card-l"><div class="n">–û–ó–£</div><div class="d">8 –ì–ë DDR5</div></div></div><div class="set-card"><div class="set-card-l"><div class="n">AI</div><div class="d">Exian.AI 3.0 ‚Äî –£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</div></div></div></div>
      </div>
    </div>
  </div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-settings')"></div>
</div>

<!-- BROWSER -->
<div class="window" id="win-browser" style="width:820px;height:560px;top:40px;left:50px;" onclick="bringFront('win-browser')">
  <div class="titlebar" onmousedown="dragWin(event,'win-browser')">
    <span class="tb-icon">üåê</span><span class="tb-title">ExiWin Edge</span>
    <div class="win-btns"><div class="wb" onclick="minimizeWin('browser')">‚îÄ</div><div class="wb" onclick="toggleMax('win-browser')">‚¨ú</div><div class="wb cls" onclick="closeWin('browser')">‚úï</div></div>
  </div>
  <div class="win-body">
    <div class="br-wrap">
      <div class="br-bar">
        <div class="br-nav" onclick="brBack()">‚óÄ</div><div class="br-nav" onclick="brForward()">‚ñ∂</div><div class="br-nav" onclick="brRefresh()">üîÉ</div><div class="br-nav" onclick="brNewTab()">üè†</div>
        <input class="br-url-bar" id="br-url" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å..." onkeydown="brKeyNav(event)">
        <div class="br-nav" onclick="brNavigate(el('br-url').value)">‚Üí</div>
      </div>
      <div id="br-newtab">
        <div class="br-greeting" id="br-hello">–î–æ–±—Ä—ã–π –¥–µ–Ω—å!</div>
        <div class="br-searchbar"><span>üîç</span><input type="text" id="br-search-input" placeholder="–ü–æ–∏—Å–∫..."><button onclick="brSearch(el('br-search-input').value)">–ù–∞–π—Ç–∏</button></div>
        <div class="br-shortcuts">
          <div class="br-sc" onclick="brShortcut('https://google.com')"><div class="ico">üîç</div><span>Google</span></div>
          <div class="br-sc" onclick="brShortcut('https://github.com')"><div class="ico">üêô</div><span>GitHub</span></div>
          <div class="br-sc" onclick="brShortcut('https://youtube.com')"><div class="ico">‚ñ∂Ô∏è</div><span>YouTube</span></div>
          <div class="br-sc" onclick="brShortcut('https://wikipedia.org')"><div class="ico">üìñ</div><span>Wikipedia</span></div>
          <div class="br-sc" onclick="brShortcut('https://stackoverflow.com')"><div class="ico">üí¨</div><span>Stack Overflow</span></div>
        </div>
      </div>
      <iframe id="br-frame" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
    </div>
  </div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-browser')"></div>
</div>

<!-- PAINT -->
<div class="window" id="win-paint" style="width:760px;height:540px;top:40px;left:60px;" onclick="bringFront('win-paint')">
  <div class="titlebar" onmousedown="dragWin(event,'win-paint')">
    <span class="tb-icon">üé®</span><span class="tb-title">Paint</span>
    <div class="win-btns"><div class="wb" onclick="minimizeWin('paint')">‚îÄ</div><div class="wb" onclick="toggleMax('win-paint')">‚¨ú</div><div class="wb cls" onclick="closeWin('paint')">‚úï</div></div>
  </div>
  <div class="win-body">
    <div class="paint-wrap">
      <div class="paint-toolbar">
        <div class="paint-tool active" onclick="selectPaintTool('pen',this)">‚úèÔ∏è</div>
        <div class="paint-tool" onclick="selectPaintTool('eraser',this)">üßπ</div>
        <div class="paint-tool" onclick="selectPaintTool('fill',this)">ü™£</div>
        <div class="paint-tool" onclick="paintClear()">üóëÔ∏è</div>
        <div class="paint-tool" onclick="paintSave()">üíæ</div>
        <div style="width:1px;height:24px;background:var(--border)"></div>
        <div class="paint-colors">
          <div class="paint-color active" style="background:#0078d4" onclick="selectPaintColor('#0078d4',this)"></div>
          <div class="paint-color" style="background:#e74c3c" onclick="selectPaintColor('#e74c3c',this)"></div>
          <div class="paint-color" style="background:#2ecc71" onclick="selectPaintColor('#2ecc71',this)"></div>
          <div class="paint-color" style="background:#f1c40f" onclick="selectPaintColor('#f1c40f',this)"></div>
          <div class="paint-color" style="background:#9b59b6" onclick="selectPaintColor('#9b59b6',this)"></div>
          <div class="paint-color" style="background:#e67e22" onclick="selectPaintColor('#e67e22',this)"></div>
          <div class="paint-color" style="background:#1abc9c" onclick="selectPaintColor('#1abc9c',this)"></div>
          <div class="paint-color" style="background:#ff69b4" onclick="selectPaintColor('#ff69b4',this)"></div>
          <div class="paint-color" style="background:#000" onclick="selectPaintColor('#000000',this)"></div>
          <div class="paint-color" style="background:#fff;border-color:var(--border)" onclick="selectPaintColor('#ffffff',this)"></div>
        </div>
        <div class="paint-size"><span>–†–∞–∑–º–µ—Ä:</span><input type="range" min="1" max="30" value="4" oninput="setPaintSize(this.value)"><span id="paint-size-val">4px</span></div>
      </div>
      <div class="paint-canvas-wrap" id="paint-canvas-wrap"><canvas id="paint-canvas"></canvas></div>
    </div>
  </div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-paint')"></div>
</div>

<!-- TASK MANAGER -->
<div class="window" id="win-taskman" style="width:700px;height:500px;top:50px;left:80px;" onclick="bringFront('win-taskman')">
  <div class="titlebar" onmousedown="dragWin(event,'win-taskman')">
    <span class="tb-icon">üìä</span><span class="tb-title">–î–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á</span>
    <div class="win-btns"><div class="wb" onclick="minimizeWin('taskman')">‚îÄ</div><div class="wb" onclick="toggleMax('win-taskman')">‚¨ú</div><div class="wb cls" onclick="closeWin('taskman')">‚úï</div></div>
  </div>
  <div class="win-body">
    <div class="tm-wrap">
      <div class="tm-tabs">
        <div class="tm-tab active" data-tab="processes" onclick="tmRender('processes')">–ü—Ä–æ—Ü–µ—Å—Å—ã</div>
        <div class="tm-tab" data-tab="performance" onclick="tmRender('performance')">–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
        <div class="tm-tab" data-tab="startup" onclick="tmRender('startup')">–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞</div>
      </div>
      <div class="tm-body">
        <table class="tm-table" id="tm-proc-table"><thead><tr><th>–ò–º—è</th><th>–¶–ü</th><th>–û–ó–£</th><th>PID</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody id="tm-proc-body"></tbody></table>
        <div id="tm-perf-body" style="display:none"></div>
        <div id="tm-startup-body-wrap" style="display:none"><table class="tm-table"><thead><tr><th>–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</th><th>–í–ª–∏—è–Ω–∏–µ</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody id="tm-startup-body"></tbody></table></div>
      </div>
    </div>
  </div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-taskman')"></div>
</div>

<!-- EXIAN.AI 3.0 -->
<div class="window" id="win-exianai" style="width:900px;height:620px;top:30px;left:50px;" onclick="bringFront('win-exianai')">
  <div class="titlebar" onmousedown="dragWin(event,'win-exianai')">
    <span class="tb-icon">ü§ñ</span><span class="tb-title">Exian.AI 3.0 ‚Äî –£–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
    <div class="win-btns">
      <div class="wb" onclick="minimizeWin('exianai')">‚îÄ</div>
      <div class="wb" onclick="toggleMax('win-exianai')">‚¨ú</div>
      <div class="wb cls" onclick="closeWin('exianai')">‚úï</div>
    </div>
  </div>
  <div class="win-body" style="overflow:hidden">
    <div class="echat-wrap">
      <div class="echat-sidebar">
        <div class="echat-sidebar-header">
          <span>üí¨ –ß–∞—Ç—ã</span>
          <button class="echat-new-btn" onclick="newExianChat()">+ –ù–æ–≤—ã–π</button>
        </div>
        <div id="exian-sessions-list"></div>
        <div class="echat-sidebar-footer">
          <div class="echat-clear-btn" onclick="clearAllChats()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —á–∞—Ç—ã</div>
        </div>
      </div>
      <div class="echat-main">
        <div class="echat-header">
          <div class="echat-header-ico">ü§ñ</div>
          <div class="echat-header-info">
            <div class="echat-header-name">Exian.AI 3.0</div>
            <div class="echat-header-status">–û–Ω–ª–∞–π–Ω ¬∑ ExiWin 12</div>
          </div>
        </div>
        <div class="echat-quick">
          <div class="echat-quick-btn" onclick="exianQuickPrompt('–ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?')">ü§î –ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?</div>
          <div class="echat-quick-btn" onclick="exianQuickPrompt('–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python')">üíª –ö–æ–¥ –Ω–∞ Python</div>
          <div class="echat-quick-btn" onclick="exianQuickPrompt('–û–±—ä—è—Å–Ω–∏ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç—å')">üß† –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç AI?</div>
          <div class="echat-quick-btn" onclick="exianQuickPrompt('–ü—Ä–∏–¥—É–º–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω—É—é –∏–¥–µ—é –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞')">üí° –ò–¥–µ—è –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞</div>
          <div class="echat-quick-btn" onclick="exianQuickPrompt('–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç')">üòÑ –†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç</div>
        </div>
        <div id="exian-chat-messages"></div>
        <div class="echat-input-area">
          <div class="echat-input-row">
            <textarea id="exian-chat-input" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å... (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)" rows="1"></textarea>
            <button id="exian-send-btn" onclick="exianSendMessage()" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
          </div>
          <div class="echat-hint">Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ¬∑ Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ¬∑ Exian.AI 3.0 powered by ExiWin 12</div>
        </div>
      </div>
    </div>
  </div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-exianai')"></div>
</div>

<!-- EXIBLOX -->
<div class="window" id="win-exiblox" style="width:1100px;height:700px;top:20px;left:40px;" onclick="bringFront('win-exiblox')">
  <div class="titlebar" onmousedown="dragWin(event,'win-exiblox')">
    <span class="tb-icon">üêç</span>
    <span class="tb-title">Exiblox v3</span>
    <div class="win-btns">
      <div class="wb" onclick="minimizeWin('exiblox')">‚îÄ</div>
      <div class="wb" onclick="toggleMax('win-exiblox')">‚¨ú</div>
      <div class="wb cls" onclick="closeWin('exiblox')">‚úï</div>
    </div>
  </div>
  <div class="win-body" id="exiblox-root" style="overflow:hidden;"></div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-exiblox')"></div>
</div>

<!-- GTA 6 -->
<div class="window" id="win-gta6" style="width:1020px;height:680px;top:18px;left:30px;" onclick="bringFront('win-gta6')">
  <div class="titlebar" onmousedown="dragWin(event,'win-gta6')">
    <span class="tb-icon">üéÆ</span>
    <span class="tb-title">GTA 6 ‚Äî ExiWin City</span>
    <div class="win-btns">
      <div class="wb" onclick="minimizeWin('gta6')">‚îÄ</div>
      <div class="wb" onclick="toggleMax('win-gta6')">‚¨ú</div>
      <div class="wb cls" onclick="gta6Close()">‚úï</div>
    </div>
  </div>
  <div class="win-body" id="gta6-root" style="overflow:hidden;padding:0;"></div>
  <div class="resize-handle" onmousedown="resizeWin(event,'win-gta6')"></div>
</div>

<div class="tb-btn" id="tb-exiblox" onclick="tbClick('exiblox')">üêç</div>

<div id="notif-stack"></div>

<script src="app.js"></script>
<script src="windows.js"></script>
<script src="apps.js"></script>
<script src="exianai.js"></script>
<script src="exiblox.js"></script>

<!-- DESKTOP ICON DRAG -->
<script>
(function(){
  let dragEl=null, dragOffX=0, dragOffY=0, hasMoved=false;
  const THRESHOLD=5;
  let startX=0,startY=0;
  window.iconDragStart=function(e,el){
    if(e.button!==0)return;
    dragEl=el; startX=e.clientX; startY=e.clientY;
    const rect=el.getBoundingClientRect();
    dragOffX=e.clientX-rect.left; dragOffY=e.clientY-rect.top;
    hasMoved=false; e.stopPropagation();
  };
  document.addEventListener('mousemove',function(e){
    if(!dragEl)return;
    const dx=Math.abs(e.clientX-startX), dy=Math.abs(e.clientY-startY);
    if(!hasMoved && dx<THRESHOLD && dy<THRESHOLD)return;
    if(!hasMoved){hasMoved=true;dragEl.classList.add('dragging-icon');}
    const desk=document.getElementById('desktop');
    const deskRect=desk.getBoundingClientRect();
    let nx=e.clientX-deskRect.left-dragOffX;
    let ny=e.clientY-deskRect.top-dragOffY;
    nx=Math.max(0,Math.min(nx,deskRect.width-dragEl.offsetWidth));
    ny=Math.max(0,Math.min(ny,deskRect.height-dragEl.offsetHeight));
    dragEl.style.left=nx+'px'; dragEl.style.top=ny+'px';
    e.preventDefault();
  });
  document.addEventListener('mouseup',function(e){
    if(!dragEl)return;
    dragEl.classList.remove('dragging-icon'); dragEl=null;
  });
})();
</script>

<!-- WALLPAPER GALLERY -->
<script>
const WALLPAPERS = {
  dark:[
    {id:'dark-default',name:'Midnight Blue (–ø–æ —É–º–æ–ª—á.)',css:'linear-gradient(160deg,#040c1a 0%,#061020 40%,#040c18 100%)',isDefault:true},
    {id:'dark-nebula',name:'–¢—É–º–∞–Ω–Ω–æ—Å—Ç—å',css:'radial-gradient(ellipse at 30% 40%,#1a0040 0%,#060010 50%,#001020 100%)'},
    {id:'dark-aurora',name:'–°–µ–≤–µ—Ä–Ω–æ–µ —Å–∏—è–Ω–∏–µ',css:'linear-gradient(160deg,#001a10 0%,#003322 30%,#002244 60%,#001133 100%)'},
    {id:'dark-volcano',name:'–í—É–ª–∫–∞–Ω',css:'radial-gradient(ellipse at 50% 90%,#3d0000 0%,#1a0000 40%,#0a0005 100%)'},
    {id:'dark-ocean',name:'–ì–ª—É–±–æ–∫–∏–π –æ–∫–µ–∞–Ω',css:'linear-gradient(180deg,#000d1a 0%,#001428 50%,#001f3d 100%)'},
    {id:'dark-galaxy',name:'–ì–∞–ª–∞–∫—Ç–∏–∫–∞',css:'radial-gradient(ellipse at 70% 30%,#0d001a 0%,#120033 40%,#000010 100%)'},
    {id:'dark-matrix',name:'–ú–∞—Ç—Ä–∏—Ü–∞',css:'linear-gradient(160deg,#001400 0%,#002000 50%,#000a00 100%)'},
    {id:'dark-copper',name:'–ú–µ–¥—å',css:'linear-gradient(135deg,#1a0a00 0%,#2d1200 40%,#0f0700 100%)'},
    {id:'dark-steel',name:'–°—Ç–∞–ª—å',css:'linear-gradient(160deg,#0a0e14 0%,#131b26 50%,#0a0d13 100%)'},
    {id:'dark-purple',name:'–¢—ë–º–Ω—ã–π –ø—É—Ä–ø—É—Ä',css:'linear-gradient(135deg,#0d0020 0%,#1a0035 50%,#08001a 100%)'},
    {id:'dark-rose',name:'–¢—ë–º–Ω–∞—è —Ä–æ–∑–∞',css:'linear-gradient(135deg,#1a0010 0%,#2d0022 50%,#0f0009 100%)'},
    {id:'dark-arctic',name:'–ê—Ä–∫—Ç–∏—á–µ—Å–∫–∞—è –Ω–æ—á—å',css:'linear-gradient(180deg,#000814 0%,#001022 40%,#001530 70%,#000a1a 100%)'},
    {id:'dark-teal',name:'–ö–∏–ø–∞—Ä–∏—Å',css:'linear-gradient(135deg,#001a1a 0%,#002d2d 50%,#000f0f 100%)'},
    {id:'dark-indigo',name:'–ò–Ω–¥–∏–≥–æ',css:'linear-gradient(160deg,#050020 0%,#0a003d 50%,#030015 100%)'},
    {id:'dark-ember',name:'–£–≥–ª–∏',css:'radial-gradient(ellipse at 50% 80%,#200500 0%,#100200 50%,#050000 100%)'},
    {id:'dark-storm',name:'–®—Ç–æ—Ä–º',css:'linear-gradient(160deg,#0a0a14 0%,#14141e 40%,#0a0a10 100%)'},
  ],
  light:[
    {id:'light-default',name:'Sky Blue (–ø–æ —É–º–æ–ª—á.)',css:'linear-gradient(160deg,#dceeff 0%,#eef4fb 40%,#d8eaf5 100%)',isDefault:true},
    {id:'light-peach',name:'–ü–µ—Ä—Å–∏–∫',css:'linear-gradient(160deg,#fff3e0 0%,#ffe8cc 50%,#fff0d8 100%)'},
    {id:'light-mint',name:'–ú—è—Ç–∞',css:'linear-gradient(160deg,#e0fff4 0%,#ccf5e8 50%,#d8fff0 100%)'},
    {id:'light-lavender',name:'–õ–∞–≤–∞–Ω–¥–∞',css:'linear-gradient(160deg,#f0e6ff 0%,#e8d5ff 50%,#eeddff 100%)'},
    {id:'light-rose',name:'–†–æ–∑–∞',css:'linear-gradient(160deg,#ffe6ee 0%,#ffd5e3 50%,#ffdde8 100%)'},
    {id:'light-lime',name:'–õ–∞–π–º',css:'linear-gradient(160deg,#edffd6 0%,#e0ffb8 50%,#e8ffcc 100%)'},
    {id:'light-aqua',name:'–ê–∫–≤–∞',css:'linear-gradient(160deg,#d6f8ff 0%,#b8f0ff 50%,#c8f4ff 100%)'},
    {id:'light-blush',name:'–†—É–º—è–Ω–µ—Ü',css:'linear-gradient(160deg,#ffe8e8 0%,#ffd0d0 50%,#ffdddd 100%)'},
    {id:'light-sand',name:'–ü–µ—Å–æ–∫',css:'linear-gradient(160deg,#fff8e0 0%,#fff2c0 50%,#fff5d0 100%)'},
    {id:'light-lilac',name:'–°–∏—Ä–µ–Ω—å',css:'linear-gradient(160deg,#f8e6ff 0%,#f0d0ff 50%,#f4dcff 100%)'},
    {id:'light-cream',name:'–ö—Ä–µ–º',css:'linear-gradient(160deg,#fffcf0 0%,#fff8e0 50%,#fffae8 100%)'},
    {id:'light-gold',name:'–ó–æ–ª–æ—Ç–æ',css:'linear-gradient(160deg,#fff8d6 0%,#fff0b0 50%,#fff4c0 100%)'},
    {id:'light-mist',name:'–¢—É–º–∞–Ω',css:'linear-gradient(160deg,#eef2f8 0%,#e4eaf4 50%,#e8eef6 100%)'},
    {id:'light-cyan',name:'–ë–∏—Ä—é–∑–∞',css:'linear-gradient(160deg,#e0f8ff 0%,#c8f2ff 50%,#d4f6ff 100%)'},
    {id:'light-coral',name:'–ö–æ—Ä–∞–ª–ª',css:'linear-gradient(160deg,#fff0e8 0%,#ffe4d4 50%,#ffeadc 100%)'},
    {id:'light-sage',name:'–®–∞–ª—Ñ–µ–π',css:'linear-gradient(160deg,#e8f4ee 0%,#d8eedf 50%,#e0f0e6 100%)'},
  ]
};
let currentWpTab='dark';
let currentWpId={dark:'dark-default',light:'light-default'};
let isLightTheme=false;
window.openWallpaperGallery=function(mode){
  currentWpTab=mode||'dark';
  const g=document.getElementById('wallpaper-gallery');
  const heading=document.getElementById('wp-gallery-heading');
  heading.textContent=currentWpTab==='dark'?'üñºÔ∏è –í—ã–±–æ—Ä –æ–±–æ–µ–≤ ‚Äî –¢—ë–º–Ω—ã–µ':'üñºÔ∏è –í—ã–±–æ—Ä –æ–±–æ–µ–≤ ‚Äî –°–≤–µ—Ç–ª—ã–µ';
  document.getElementById('wp-tab-dark').classList.toggle('active',currentWpTab==='dark');
  document.getElementById('wp-tab-light').classList.toggle('active',currentWpTab==='light');
  renderWpGrid(currentWpTab);
  document.getElementById('tray-popup').style.display='none';
  g.style.display='block';
};
window.closeWallpaperGallery=function(){document.getElementById('wallpaper-gallery').style.display='none';};
window.wpSwitchTab=function(tab){
  currentWpTab=tab;
  document.getElementById('wp-tab-dark').classList.toggle('active',tab==='dark');
  document.getElementById('wp-tab-light').classList.toggle('active',tab==='light');
  document.getElementById('wp-gallery-heading').textContent=tab==='dark'?'üñºÔ∏è –í—ã–±–æ—Ä –æ–±–æ–µ–≤ ‚Äî –¢—ë–º–Ω—ã–µ':'üñºÔ∏è –í—ã–±–æ—Ä –æ–±–æ–µ–≤ ‚Äî –°–≤–µ—Ç–ª—ã–µ';
  renderWpGrid(tab);
};
function renderWpGrid(tab){
  const grid=document.getElementById('wp-grid');
  grid.innerHTML='';
  WALLPAPERS[tab].forEach(wp=>{
    const div=document.createElement('div');
    div.className='wp-item'+(currentWpId[tab]===wp.id?' wp-active':'');
    div.style.background=wp.css; div.title=wp.name;
    const lbl=document.createElement('div'); lbl.className='wp-item-label'; lbl.textContent=wp.name; div.appendChild(lbl);
    if(wp.isDefault){const badge=document.createElement('div');badge.className='wp-default-badge';badge.textContent='–ü–æ —É–º–æ–ª—á.';div.appendChild(badge);}
    div.onclick=()=>applyWallpaper(tab,wp); grid.appendChild(div);
  });
}
function applyWallpaper(tab,wp){
  currentWpId[tab]=wp.id;
  const wasLight=document.body.classList.contains('light-theme');
  if(tab==='light'&&!wasLight){document.body.classList.add('light-theme');isLightTheme=true;document.getElementById('tr-light-theme').classList.remove('off');document.getElementById('tr-dark-theme').classList.add('off');}
  else if(tab==='dark'&&wasLight){document.body.classList.remove('light-theme');isLightTheme=false;document.getElementById('tr-dark-theme').classList.remove('off');document.getElementById('tr-light-theme').classList.add('off');}
  document.getElementById('desktop').style.background=wp.css;
  document.documentElement.style.setProperty('--desktop-bg',wp.css);
  renderWpGrid(currentWpTab);
  if(typeof showNotif==='function') showNotif('–û–±–æ–∏ –∏–∑–º–µ–Ω–µ–Ω—ã','–§–æ–Ω ¬´'+wp.name+'¬ª –ø—Ä–∏–º–µ–Ω—ë–Ω','üñºÔ∏è');
}
document.addEventListener('click',function(e){
  const g=document.getElementById('wallpaper-gallery');
  if(g.style.display==='block'&&!g.contains(e.target)) g.style.display='none';
});
</script>

<!-- PATCHES -->
<script>
const _tm = tmRender;
tmRender = function(tab) {
  document.querySelectorAll('.tm-tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
  const proc=el('tm-proc-table'), perf=el('tm-perf-body'), start=el('tm-startup-body-wrap');
  if(proc) proc.style.display=tab==='processes'?'table':'none';
  if(perf) perf.style.display=tab==='performance'?'block':'none';
  if(start) start.style.display=tab==='startup'?'block':'none';
  if(tab==='processes') tmRenderProcesses();
  else if(tab==='performance') tmRenderPerf();
  else if(tab==='startup') tmRenderStartup();
};
window.addEventListener('DOMContentLoaded',()=>{
  const h=new Date().getHours(), g=el('br-hello');
  if(g) g.textContent=h<6?'–î–æ–±—Ä–æ–π –Ω–æ—á–∏!':h<12?'–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!':h<18?'–î–æ–±—Ä—ã–π –¥–µ–Ω—å!':'–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!';
});
window.addEventListener('DOMContentLoaded',()=>{ setExpView('large'); });
</script>
<script src="phone.js"></script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GTA 6 ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GTA 6 ‚Äî ExiWin Edition  ‚Ä¢  Full City Sandbox
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.GTA6 = (function () {

// ‚îÄ‚îÄ Math helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const abs=Math.abs,sqrt=Math.sqrt,sin=Math.sin,cos=Math.cos,
      atan2=Math.atan2,PI=Math.PI,floor=Math.floor,min=Math.min,max=Math.max;
const clamp=(v,a,b)=>max(a,min(b,v));
const lerp=(a,b,t)=>a+(b-a)*t;
const dst=(ax,ay,bx,by)=>sqrt((ax-bx)**2+(ay-by)**2);
const rnd=(a,b)=>Math.random()*(b-a)+a;
const pick=arr=>arr[floor(Math.random()*arr.length)];
const lerpA=(a,b,t)=>{
  let d=b-a; while(d>PI)d-=PI*2; while(d<-PI)d+=PI*2; return a+d*t;
};
// hash for stable random
const hash=(x,y)=>{let h=(x*374761393+y*668265263);h=((h^(h>>13))*1274126177);return abs(h%1000)/1000;};

// ‚îÄ‚îÄ World constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TILE=48, MAP_W=110, MAP_H=110;
const ROAD=0,SIDEWALK=1,BUILDING=2,PARK=3,WATER=4;

// ‚îÄ‚îÄ Palettes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAR_COLORS=['#e74c3c','#e67e22','#f1c40f','#2ecc71','#1abc9c',
  '#3498db','#9b59b6','#ff69b4','#ecf0f1','#2c3e50','#95a5a6',
  '#c0392b','#27ae60','#2980b9','#8e44ad','#d35400','#16a085',
  '#f39c12','#7f8c8d','#bdc3c7'];
const SKIN=['#f5cba7','#e59866','#d4a574','#c07a4a','#a0522d','#f0e0c8','#e8c9a0'];
const SHIRTS=['#e74c3c','#3498db','#2ecc71','#f1c40f','#9b59b6','#e67e22',
  '#1abc9c','#ff69b4','#95a5a6','#c0392b','#27ae60','#2980b9','#16a085'];
const PANTS=['#2c3e50','#1a252f','#34495e','#5d6d7e','#4a4a6a','#1a1a2e'];
const BZONE={
  downtown:['#5a6b7a','#6b7c8b','#4a5b6a','#7a8b9a','#8a9baa','#3a4b5a'],
  midtown: ['#b8945a','#a07840','#c8a870','#907030','#d4b070','#806028','#9a8050'],
  uptown:  ['#8b7a6a','#9a8a7a','#7a6a5a','#aa9a8a','#6a5a4a','#ba9a7a'],
  industry:['#707070','#808080','#606060','#787878','#6a6a6a','#757575'],
};

// ‚îÄ‚îÄ Entity IDs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _eid=1;
class Entity{constructor(x,y){this.x=x;this.y=y;this.vx=0;this.vy=0;this.angle=0;this.alive=true;this.id=_eid++;}}

// ‚îÄ‚îÄ Player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Player extends Entity{
  constructor(x,y){
    super(x,y); this.w=14;this.h=14;
    this.speed=150; this.health=100; this.maxHealth=100;
    this.inCar=null; this.money=2500;
    this.skinColor=pick(SKIN); this.shirtColor=pick(SHIRTS); this.pantsColor=pick(PANTS);
    this.animFrame=0; this.animTimer=0;
    this._fCool=0; this._gCool=0;
  }
}

// ‚îÄ‚îÄ Car ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Car extends Entity{
  constructor(x,y,color,type){
    super(x,y); this.color=color||pick(CAR_COLORS); this.type=type||'sedan';
    this.w=type==='truck'?38:type==='suv'?34:30;
    this.h=type==='truck'?20:type==='suv'?18:16;
    this.speed=0;
    this.maxSpeed=type==='sports'?280:type==='truck'?120:type==='suv'?200:210;
    this.accel=type==='sports'?220:type==='truck'?80:160;
    this.handling=type==='sports'?3.8:type==='truck'?1.4:type==='suv'?2.8:2.6;
    this.driver=null; this.passenger=null;
    this.isParked=true; this.aiState='parked';
    this.aiTimer=rnd(1,5); this.aiAngle=this.angle;
    this.health=100; this.isPolice=(type==='police');
    this.brakeLight=false; this.sirenOn=false;
    this.colorNum=floor(Math.random()*10000);
  }
}

// ‚îÄ‚îÄ NPC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class NPC extends Entity{
  constructor(x,y){
    super(x,y); this.w=10;this.h=10;
    this.speed=rnd(45,85);
    this.skinColor=pick(SKIN); this.shirtColor=pick(SHIRTS); this.pantsColor=pick(PANTS);
    this.dir={x:0,y:1}; this.aiState='walk';
    this.aiTimer=rnd(2,6); this.turnTimer=rnd(1,5);
    this.health=100; this.isPolice=false;
    this.animFrame=0; this.animTimer=0;
    this.fleeing=false;
  }
}

// ‚îÄ‚îÄ Police officer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class Officer extends NPC{
  constructor(x,y){
    super(x,y); this.isPolice=true;
    this.speed=170; this.shirtColor='#1a3a6b'; this.pantsColor='#0d1f3a';
    this.skinColor=pick(SKIN); this.aiState='patrol'; this.chasing=false;
  }
}

// ‚îÄ‚îÄ World generation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeWorld(){
  const map=Array.from({length:MAP_H},()=>new Uint8Array(MAP_W).fill(BUILDING));
  const bColors=[]; for(let y=0;y<MAP_H;y++){bColors[y]=[];}

  // Road grid ‚Äî major arteries every 13 tiles (2-lane = 2 tiles wide)
  const roadX=[], roadY=[];
  for(let x=10;x<MAP_W-4;x+=13){roadX.push(x,x+1);}
  for(let y=10;y<MAP_H-4;y+=13){roadY.push(y,y+1);}
  // Extra diagonal cross roads
  for(let x=16;x<MAP_W-4;x+=13){roadX.push(x,x+1);}

  for(let y=0;y<MAP_H;y++)
    for(let x=0;x<MAP_W;x++)
      if(roadX.includes(x)||roadY.includes(y)) map[y][x]=ROAD;

  // Sidewalks (1 tile border around road blocks)
  for(let y=1;y<MAP_H-1;y++)
    for(let x=1;x<MAP_W-1;x++)
      if(map[y][x]===BUILDING){
        let adj=false;
        for(const[dx,dy]of[[-1,0],[1,0],[0,-1],[0,1]])
          if(map[y+dy]?.[x+dx]===ROAD){adj=true;break;}
        if(adj) map[y][x]=SIDEWALK;
      }

  // Water zone (top-left corner)
  for(let y=0;y<12;y++) for(let x=0;x<12;x++) map[y][x]=WATER;

  // Parks
  for(let y=0;y<MAP_H;y++)
    for(let x=0;x<MAP_W;x++)
      if(map[y][x]===BUILDING && hash(x*3,y*3)<0.04)
        map[y][x]=PARK;

  // Building colors
  function zonePal(x,y){
    const cx=MAP_W/2,cy=MAP_H/2,d=dst(x,y,cx,cy);
    if(d<18) return BZONE.downtown;
    if(d<35) return BZONE.midtown;
    if(d<50) return BZONE.uptown;
    return BZONE.industry;
  }
  for(let y=0;y<MAP_H;y++)
    for(let x=0;x<MAP_W;x++)
      if(map[y][x]===BUILDING){
        const p=zonePal(x,y);
        bColors[y][x]=p[floor(hash(x*7,y*7)*p.length)];
      }

  // Building heights (for visual depth)
  const bHeight=[];
  for(let y=0;y<MAP_H;y++){
    bHeight[y]=[];
    for(let x=0;x<MAP_W;x++)
      bHeight[y][x]=map[y][x]===BUILDING?floor(hash(x*11,y*13)*5+1):0;
  }

  return {map,bColors,bHeight,roadX,roadY};
}

// ‚îÄ‚îÄ Game state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let S={
  canvas:null,ctx:null,W:800,H:600,
  running:false,initialized:false,
  world:null,
  cam:{x:0,y:0},
  player:null,
  cars:[],npcs:[],officers:[],
  wantedLevel:0,wantedCooldown:0,
  score:0,keys:{},mouse:{x:0,y:0},
  lastTime:0,frameCount:0,gameTime:0,
  spawnCooldown:0,policeCooldown:0,
  notifs:[],
  hud:null,mmCanvas:null,
  _listeners:[],
  nightMode:false,
  dayTime:8, // hour 0-24
  totalKills:0,
};

// ‚îÄ‚îÄ Initialise ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init(rootEl){
  if(!rootEl) return;
  // Clean
  if(S.canvas&&S.canvas.parentNode) S.canvas.parentNode.removeChild(S.canvas);
  if(S.mmCanvas&&S.mmCanvas.parentNode) S.mmCanvas.parentNode.removeChild(S.mmCanvas);
  for(const[el,ev,fn] of S._listeners) el.removeEventListener(ev,fn);
  S._listeners=[];
  rootEl.innerHTML='';
  rootEl.style.cssText='position:relative;overflow:hidden;background:#000;';

  // Main canvas
  const canvas=document.createElement('canvas');
  canvas.style.cssText='position:absolute;inset:0;width:100%;height:100%;cursor:crosshair;';
  canvas.tabIndex=0;
  rootEl.appendChild(canvas);

  // HUD overlay
  const hud=document.createElement('div');
  hud.style.cssText='position:absolute;inset:0;pointer-events:none;z-index:5;font-family:\'Segoe UI\',sans-serif;';
  rootEl.appendChild(hud);

  // Minimap canvas
  const mm=document.createElement('canvas');
  mm.style.cssText='position:absolute;bottom:56px;right:10px;width:140px;height:140px;border-radius:50%;border:2px solid rgba(255,255,255,.35);box-shadow:0 0 12px rgba(0,0,0,.8);z-index:6;pointer-events:none;';
  mm.width=140;mm.height=140;
  rootEl.appendChild(mm);

  // On-screen buttons
  const btns=document.createElement('div');
  btns.style.cssText='position:absolute;bottom:8px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:10;pointer-events:all;';
  btns.innerHTML=`
    <button id="gta6-spawn-btn" style="background:rgba(0,80,200,.88);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:11.5px;cursor:pointer;font-family:inherit;font-weight:600;">üöó –°–ø–∞–≤–Ω –º–∞—à–∏–Ω—ã [G]</button>
    <button id="gta6-sports-btn" style="background:rgba(200,80,0,.88);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:11.5px;cursor:pointer;font-family:inherit;font-weight:600;">üèéÔ∏è –°–ø–æ—Ä—Ç–∫–∞—Ä [T]</button>
    <button id="gta6-clear-btn" style="background:rgba(50,50,50,.88);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:11.5px;cursor:pointer;font-family:inherit;font-weight:600;">‚≠ê –°–Ω—è—Ç—å —Ä–æ–∑—ã—Å–∫</button>
    <button id="gta6-health-btn" style="background:rgba(0,150,80,.88);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:11.5px;cursor:pointer;font-family:inherit;font-weight:600;">‚ù§Ô∏è –ê–ø—Ç–µ—á–∫–∞ [$100]</button>
  `;
  rootEl.appendChild(btns);
  btns.querySelector('#gta6-spawn-btn').onclick=()=>spawnCarNearPlayer('sedan');
  btns.querySelector('#gta6-sports-btn').onclick=()=>spawnCarNearPlayer('sports');
  btns.querySelector('#gta6-clear-btn').onclick=clearWanted;
  btns.querySelector('#gta6-health-btn').onclick=buyHealth;

  S.canvas=canvas; S.ctx=canvas.getContext('2d');
  S.hud=hud; S.mmCanvas=mm;

  // Resize
  function resize(){
    const r=rootEl.getBoundingClientRect();
    canvas.width=max(400,r.width||800);
    canvas.height=max(300,r.height-36||560);
    S.W=canvas.width; S.H=canvas.height;
  }
  resize();
  const ro=new ResizeObserver(resize);
  ro.observe(rootEl);
  S._listeners.push([window,'resize',resize]);

  // Keys
  const kd=e=>{S.keys[e.code]=true; if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code))e.preventDefault();};
  const ku=e=>{ S.keys[e.code]=false; };
  const addL=(el,ev,fn)=>{ el.addEventListener(ev,fn); S._listeners.push([el,ev,fn]); };
  addL(window,'keydown',kd); addL(window,'keyup',ku);
  canvas.addEventListener('click',()=>canvas.focus());

  // Generate world
  S.world=makeWorld();

  // Player at city center
  const startX=(MAP_W/2)*TILE+TILE/2, startY=(MAP_H/2)*TILE+TILE/2;
  S.player=new Player(startX,startY);
  S.cars=[]; S.npcs=[]; S.officers=[];
  S.wantedLevel=0; S.wantedCooldown=0;
  S.score=0; S.spawnCooldown=0; S.policeCooldown=0;
  S.frameCount=0; S.gameTime=0; S.dayTime=10;
  S.notifs=[];

  spawnInitialCars();
  spawnInitialNPCs();

  S.cam={x:startX-S.W/2,y:startY-S.H/2};
  S.running=true; S.initialized=true;
  S.lastTime=performance.now();

  notify('üéÆ WASD ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ ‚Ä¢ F ‚Äî –≤–æ–π—Ç–∏/–≤—ã–π—Ç–∏ –∏–∑ –∞–≤—Ç–æ ‚Ä¢ G ‚Äî —Å–ø–∞–≤–Ω –º–∞—à–∏–Ω—ã',4500);
  setTimeout(()=>notify('üöó –ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ –ª—é–±–æ–π –º–∞—à–∏–Ω–µ –∏ –Ω–∞–∂–º–∏—Ç–µ F!',3000),1800);
  setTimeout(()=>notify('üåÜ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GTA 6 ‚Äî ExiWin Edition!',3000),200);

  canvas.focus();
  requestAnimationFrame(gameLoop);
}

// ‚îÄ‚îÄ Spawn helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function findRoadPos(){
  for(let i=0;i<500;i++){
    const rx=pick(S.world.roadX),ry=floor(rnd(2,MAP_H-2));
    if(S.world.map[ry]?.[rx]===ROAD)
      return{x:(rx+0.5)*TILE,y:(ry+0.5)*TILE};
  }
  return{x:MAP_W/2*TILE,y:MAP_H/2*TILE};
}
function findSidewalkPos(){
  for(let i=0;i<500;i++){
    const x=floor(rnd(2,MAP_W-2)),y=floor(rnd(2,MAP_H-2));
    if(S.world.map[y]?.[x]===SIDEWALK)
      return{x:(x+0.5)*TILE,y:(y+0.5)*TILE};
  }
  return{x:(MAP_W/2+5)*TILE,y:MAP_H/2*TILE};
}

function spawnInitialCars(){
  const types=['sedan','sedan','sedan','sedan','sports','suv','suv','truck'];
  let n=0;
  for(let attempt=0;attempt<3000&&n<80;attempt++){
    const p=findRoadPos();
    if(carOverlapAt(p.x,p.y,30,null)){continue;}
    const c=new Car(p.x,p.y,pick(CAR_COLORS),pick(types));
    // Snap to road angle
    if(S.world.roadX.includes(floor(p.x/TILE))) c.angle=PI/2; else c.angle=0;
    if(Math.random()<0.4){c.aiState='driving';c.isParked=false;}
    S.cars.push(c); n++;
  }
  // Spawn some police cars
  for(let i=0;i<4;i++){
    const p=findRoadPos();
    const c=new Car(p.x,p.y,pick(['#1e3a8a','#152c6b']),'police');
    c.aiState='patrol'; c.isParked=false;
    S.cars.push(c);
  }
}

function spawnInitialNPCs(){
  for(let i=0;i<100;i++){
    const p=findSidewalkPos();
    const ang=Math.random()*PI*2;
    const npc=new NPC(p.x,p.y);
    npc.dir={x:cos(ang),y:sin(ang)};
    S.npcs.push(npc);
  }
  for(let i=0;i<6;i++){
    const p=findSidewalkPos();
    S.officers.push(new Officer(p.x,p.y));
  }
}

function carOverlapAt(x,y,r,exclude){
  for(const c of S.cars){
    if(c===exclude) continue;
    if(dst(c.x,c.y,x,y)<r) return true;
  }
  return false;
}

// ‚îÄ‚îÄ Game loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function gameLoop(ts){
  if(!S.running||!S.canvas||!S.canvas.isConnected){S.running=false;return;}
  const dt=min((ts-S.lastTime)/1000,0.05);
  S.lastTime=ts; S.frameCount++; S.gameTime+=dt;
  S.dayTime=(S.dayTime+dt*0.015)%24; // 1 real min = ~1 game hour

  update(dt);
  render();
  drawHUD();
  drawMinimap();

  requestAnimationFrame(gameLoop);
}

// ‚îÄ‚îÄ Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function update(dt){
  const K=S.keys, p=S.player;
  if(S.spawnCooldown>0) S.spawnCooldown-=dt;
  if(S.policeCooldown>0) S.policeCooldown-=dt;

  // ‚îÄ‚îÄ Player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(p.inCar) updateDriving(dt);
  else        updateWalk(dt);

  // ‚îÄ‚îÄ F key: enter/exit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  p._fCool=max(0,p._fCool-dt);
  if(K['KeyF']&&p._fCool<=0){
    p._fCool=0.35;
    if(p.inCar){ exitCar(p); }
    else {
      const nc=nearestCar();
      if(nc&&!nc.driver&&dst(p.x,p.y,nc.x,nc.y)<55){
        enterCar(p,nc);
      } else if(nc){
        notify('üöó –ü–æ–¥–æ–π–¥–∏—Ç–µ –±–ª–∏–∂–µ –∫ –º–∞—à–∏–Ω–µ!',1200);
      }
    }
  }

  // ‚îÄ‚îÄ G key: spawn sedan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  p._gCool=max(0,p._gCool-dt);
  if(K['KeyG']&&p._gCool<=0){
    p._gCool=0.4;
    spawnCarNearPlayer('sedan');
  }
  // T key: sports
  if(K['KeyT']&&p._gCool<=0){
    p._gCool=0.4;
    spawnCarNearPlayer('sports');
  }

  // ‚îÄ‚îÄ Camera ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const tx=p.inCar?p.inCar.x:p.x, ty=p.inCar?p.inCar.y:p.y;
  S.cam.x=lerp(S.cam.x,tx-S.W/2,0.12);
  S.cam.y=lerp(S.cam.y,ty-S.H/2,0.12);
  S.cam.x=clamp(S.cam.x,0,MAP_W*TILE-S.W);
  S.cam.y=clamp(S.cam.y,0,MAP_H*TILE-S.H);

  // ‚îÄ‚îÄ Cars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const c of S.cars){
    if(c.driver===p) continue;
    updateCarAI(c,dt);
  }

  // ‚îÄ‚îÄ NPCs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const n of S.npcs) updateNPC(n,dt);
  for(const o of S.officers) updateOfficer(o,dt);

  // ‚îÄ‚îÄ Wanted: spawn police ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(S.wantedLevel>0){
    S.wantedCooldown-=dt;
    if(S.wantedCooldown<=0){
      S.wantedLevel=max(0,S.wantedLevel-1);
      S.wantedCooldown=S.wantedLevel>0?18:0;
      if(S.wantedLevel===0){
        notify('‚≠ê –ü–æ–ª–∏—Ü–∏—è –≤–∞—Å –ø–æ—Ç–µ—Ä—è–ª–∞!',2000);
        // Stand down police
        for(const c of S.cars) if(c.isPolice&&c.aiState==='chase') c.aiState='patrol';
        for(const o of S.officers) o.chasing=false;
      }
    }
    if(S.policeCooldown<=0&&S.wantedLevel>0){
      S.policeCooldown=8/S.wantedLevel;
      spawnPoliceUnit();
    }
  }

  // ‚îÄ‚îÄ Cleanup dead ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(S.frameCount%300===0){
    const px=p.inCar?p.inCar.x:p.x, py=p.inCar?p.inCar.y:p.y;
    // Remove faraway npcs
    S.npcs=S.npcs.filter(n=>!n.alive?dst(n.x,n.y,px,py)<600:true);
    // Replenish
    if(S.npcs.filter(n=>n.alive).length<80){
      for(let i=0;i<5;i++){
        const sp=findSidewalkPos(); S.npcs.push(new NPC(sp.x,sp.y));
      }
    }
    if(S.cars.filter(c=>!c.isPolice&&c.aiState!=='player').length<60){
      for(let i=0;i<4;i++){
        const p2=findRoadPos();
        if(!carOverlapAt(p2.x,p2.y,35,null)){
          const c=new Car(p2.x,p2.y,pick(CAR_COLORS),pick(['sedan','suv']));
          c.aiState='driving'; c.isParked=false;
          S.cars.push(c);
        }
      }
    }
  }

  // ‚îÄ‚îÄ Notifications ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  S.notifs=S.notifs.filter(n=>{n.t-=dt;return n.t>0;});
}

function updateWalk(dt){
  const K=S.keys,p=S.player;
  let dx=0,dy=0;
  if(K['ArrowUp']   ||K['KeyW']) dy=-1;
  if(K['ArrowDown'] ||K['KeyS']) dy=1;
  if(K['ArrowLeft'] ||K['KeyA']) dx=-1;
  if(K['ArrowRight']||K['KeyD']) dx=1;
  const run=K['ShiftLeft']||K['ShiftRight'];
  const sp=p.speed*(run?1.75:1);
  if(dx||dy){
    const len=sqrt(dx*dx+dy*dy);
    dx/=len; dy/=len;
    p.angle=atan2(dy,dx);
    p.animTimer+=dt; if(p.animTimer>0.13){p.animFrame=(p.animFrame+1)%4;p.animTimer=0;}
  }
  const nx=p.x+dx*sp*dt, ny=p.y+dy*sp*dt;
  if(!solidAt(nx,p.y)) p.x=clamp(nx,8,MAP_W*TILE-8);
  if(!solidAt(p.x,ny)) p.y=clamp(ny,8,MAP_H*TILE-8);
}

function updateDriving(dt){
  const K=S.keys,p=S.player,c=p.inCar;
  let thr=0,str=0;
  if(K['ArrowUp']   ||K['KeyW']) thr=1;
  if(K['ArrowDown'] ||K['KeyS']) thr=-0.6;
  if(K['ArrowLeft'] ||K['KeyA']) str=-1;
  if(K['ArrowRight']||K['KeyD']) str=1;
  const brake=K['Space'];

  c.speed+=thr*c.accel*dt;
  if(!thr){ c.speed*=Math.pow(0.82,dt*60/60); if(abs(c.speed)<1)c.speed=0; }
  if(brake){ c.speed*=Math.pow(0.65,dt*60/60); c.brakeLight=true; } else c.brakeLight=thr<0;
  c.speed=clamp(c.speed,-c.maxSpeed*0.45,c.maxSpeed);

  if(abs(c.speed)>8){
    c.angle+=str*c.handling*dt*(abs(c.speed)/c.maxSpeed);
  }

  const nx=c.x+cos(c.angle)*c.speed*dt;
  const ny=c.y+sin(c.angle)*c.speed*dt;
  if(!carSolid(nx,c.y,c)){c.x=nx;}else{c.speed*=-0.3;}
  if(!carSolid(c.x,ny,c)){c.y=ny;}else{c.speed*=-0.3;}
  c.x=clamp(c.x,20,MAP_W*TILE-20); c.y=clamp(c.y,20,MAP_H*TILE-20);

  // Car-car collision
  for(const o of S.cars){
    if(o===c||!o.isParked) continue;
    if(dst(c.x,c.y,o.x,o.y)<36){
      const ang=atan2(c.y-o.y,c.x-o.x);
      c.x+=cos(ang)*2; c.y+=sin(ang)*2;
      o.x-=cos(ang)*1; o.y-=sin(ang)*1;
      if(abs(c.speed)>60){ gainWanted(1); c.speed*=0.4; }
      c.speed*=0.3;
    }
  }

  // Hit NPCs
  if(abs(c.speed)>55){
    for(const n of S.npcs){
      if(!n.alive) continue;
      if(dst(c.x,c.y,n.x,n.y)<28){
        n.alive=false; S.totalKills++; gainWanted(2);
        p.money=max(0,p.money); S.score+=150;
        notify('üíÄ –ù–∞–µ–∑–¥! –†–æ–∑—ã—Å–∫ ‚Üë‚Üë',1800);
      }
    }
    // Hit officer
    for(const o of S.officers){
      if(!o.alive) continue;
      if(dst(c.x,c.y,o.x,o.y)<28){
        gainWanted(3); o.alive=false;
        notify('üö® –ù–∞–µ–∑–¥ –Ω–∞ –ø–æ–ª–∏—Ü–µ–π—Å–∫–æ–≥–æ! –í–ù–ò–ú–ê–ù–ò–ï!',2500);
      }
    }
  }

  p.x=c.x+sin(c.angle)*12; p.y=c.y-cos(c.angle)*12;

  // Police catch
  if(S.wantedLevel>0){
    for(const pc of S.cars){
      if(!pc.isPolice||pc.driver===p) continue;
      if(dst(pc.x,pc.y,c.x,c.y)<40){
        bustedPlayer();
        return;
      }
    }
    for(const o of S.officers){
      if(dst(o.x,o.y,p.x,p.y)<25&&o.chasing){
        bustedPlayer();
        return;
      }
    }
  }
}

function enterCar(p,c){
  p.inCar=c; c.driver=p; c.isParked=false; c.aiState='player';
  c.speed=0;
  notify('üöó –ï–¥–µ–º –Ω–∞ '+carName(c)+'! –£–¥–∞—á–∏!',1500);
}
function exitCar(p){
  const c=p.inCar; if(!c) return;
  c.driver=null; c.speed*=0.2; c.isParked=true; c.aiState='parked';
  // Place player beside car
  p.x=c.x+cos(c.angle+PI/2)*32; p.y=c.y+sin(c.angle+PI/2)*32;
  p.inCar=null;
  notify('üö∂ –í—ã—à–ª–∏ –∏–∑ –º–∞—à–∏–Ω—ã',1000);
}

function updateCarAI(car,dt){
  if(car.aiState==='parked') return;
  car.aiTimer-=dt;

  if(car.aiState==='patrol'||car.aiState==='driving'){
    car.speed=lerp(car.speed,70,dt*1.5);
    if(car.aiTimer<=0){
      car.aiTimer=rnd(2,6);
      // Turn at random
      car.angle+=pick([-PI/2,0,PI/2,PI]);
    }
    const nx=car.x+cos(car.angle)*car.speed*dt;
    const ny=car.y+sin(car.angle)*car.speed*dt;
    if(!carSolid(nx,car.y,car)){car.x=nx;}
    else{car.angle+=PI/2;car.aiTimer=rnd(1,2);}
    if(!carSolid(car.x,ny,car)){car.y=ny;}
    else{car.angle+=PI/2;car.aiTimer=rnd(1,2);}
    car.x=clamp(car.x,20,MAP_W*TILE-20);
    car.y=clamp(car.y,20,MAP_H*TILE-20);
  }

  if(car.aiState==='chase'){
    const p=S.player;
    const tx=p.inCar?p.inCar.x:p.x, ty=p.inCar?p.inCar.y:p.y;
    const ta=atan2(ty-car.y,tx-car.x);
    car.angle=lerpA(car.angle,ta,dt*3.5);
    car.speed=lerp(car.speed,car.maxSpeed*0.85,dt*2.5);
    const nx=car.x+cos(car.angle)*car.speed*dt;
    const ny=car.y+sin(car.angle)*car.speed*dt;
    if(!carSolid(nx,car.y,car)) car.x=nx;
    if(!carSolid(car.x,ny,car)) car.y=ny;
    car.x=clamp(car.x,20,MAP_W*TILE-20);
    car.y=clamp(car.y,20,MAP_H*TILE-20);
    car.sirenOn=true;
    if(dst(car.x,car.y,tx,ty)<42) bustedPlayer();
  }
}

function updateNPC(n,dt){
  if(!n.alive) return;
  n.aiTimer-=dt; n.turnTimer-=dt;

  const p=S.player;
  const px=p.inCar?p.inCar.x:p.x,py=p.inCar?p.inCar.y:p.y;
  const pd=dst(n.x,n.y,px,py);

  // Flee from player if close and running
  if(pd<80&&S.wantedLevel>2){
    n.fleeing=true;
  } else if(pd>200) n.fleeing=false;

  if(n.fleeing){
    const fa=atan2(n.y-py,n.x-px);
    n.dir={x:cos(fa),y:sin(fa)};
    n.aiTimer=0.5;
  } else if(n.turnTimer<=0){
    n.turnTimer=rnd(2,7);
    const a=Math.random()*PI*2;
    n.dir={x:cos(a),y:sin(a)};
  }

  const sp=n.fleeing?n.speed*1.6:n.speed;
  const nx=n.x+n.dir.x*sp*dt;
  const ny=n.y+n.dir.y*sp*dt;
  const tx2=floor(nx/TILE),ty2=floor(ny/TILE);
  const tile=S.world.map[ty2]?.[tx2];
  if(tile===SIDEWALK||tile===ROAD||tile===PARK){
    n.x=clamp(nx,4,MAP_W*TILE-4);
    n.y=clamp(ny,4,MAP_H*TILE-4);
  } else { n.turnTimer=0; }

  n.animTimer+=dt; if(n.animTimer>0.18){n.animFrame=(n.animFrame+1)%4;n.animTimer=0;}
}

function updateOfficer(o,dt){
  if(!o.alive) return;
  const p=S.player;
  const px=p.inCar?p.inCar.x:p.x,py=p.inCar?p.inCar.y:p.y;
  const pd=dst(o.x,o.y,px,py);

  if(S.wantedLevel>0){ o.chasing=true; o.aiState='chase'; }
  else { o.chasing=false; o.aiState='patrol'; }

  if(o.chasing){
    const ta=atan2(py-o.y,px-o.x);
    o.dir={x:cos(ta),y:sin(ta)};
    // Walk fast toward player
    const sp=o.speed;
    const nx=o.x+o.dir.x*sp*dt;
    const ny=o.y+o.dir.y*sp*dt;
    if(!solidAt(nx,o.y)) o.x=clamp(nx,4,MAP_W*TILE-4);
    if(!solidAt(o.x,ny)) o.y=clamp(ny,4,MAP_H*TILE-4);
    if(pd<28) bustedPlayer();
  } else {
    // Patrol
    o.aiTimer-=dt; o.turnTimer-=dt;
    if(o.turnTimer<=0){
      o.turnTimer=rnd(3,8);
      const a=Math.random()*PI*2;
      o.dir={x:cos(a),y:sin(a)};
    }
    const nx=o.x+o.dir.x*60*dt, ny=o.y+o.dir.y*60*dt;
    const tx2=floor(nx/TILE),ty2=floor(ny/TILE);
    const tile=S.world.map[ty2]?.[tx2];
    if(tile===SIDEWALK||tile===ROAD){
      o.x=clamp(nx,4,MAP_W*TILE-4);
      o.y=clamp(ny,4,MAP_H*TILE-4);
    } else o.turnTimer=0;
  }
  o.animTimer=(o.animTimer||0)+dt;
  if(o.animTimer>0.14){o.animFrame=(o.animFrame||0+1)%4;o.animTimer=0;}
}

function gainWanted(n){
  S.wantedLevel=clamp(S.wantedLevel+n,0,5);
  S.wantedCooldown=20+S.wantedLevel*5;
  for(const c of S.cars) if(c.isPolice) c.aiState='chase';
  for(const o of S.officers) o.chasing=true;
}
function clearWanted(){
  S.wantedLevel=0; S.wantedCooldown=0;
  for(const c of S.cars) if(c.isPolice&&c.aiState==='chase') c.aiState='patrol';
  for(const o of S.officers) o.chasing=false;
  notify('‚≠ê –†–æ–∑—ã—Å–∫ —Å–Ω—è—Ç!',1500);
}
function buyHealth(){
  const p=S.player;
  if(p.money<100){notify('üí∏ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!',1500);return;}
  p.money-=100; p.health=min(p.maxHealth,p.health+50);
  notify('‚ù§Ô∏è +50 –∑–¥–æ—Ä–æ–≤—å—è',1200);
}
function bustedPlayer(){
  const p=S.player;
  if(p.inCar) exitCar(p);
  p.money=max(0,p.money-500);
  clearWanted();
  p.x=(MAP_W/2)*TILE; p.y=(MAP_H/2)*TILE;
  S.score=max(0,S.score-1000);
  notify('üöî –ó–ê–î–ï–†–ñ–ê–ù! –®—Ç—Ä–∞—Ñ: $500. –ü–µ—Ä–µ–º–µ—â—ë–Ω –≤ —Ü–µ–Ω—Ç—Ä.',4000);
}
function spawnPoliceUnit(){
  const p=S.player;
  const px=p.inCar?p.inCar.x:p.x, py=p.inCar?p.inCar.y:p.y;
  const ang=Math.random()*PI*2, r=rnd(400,700);
  const x=clamp(px+cos(ang)*r,40,MAP_W*TILE-40);
  const y=clamp(py+sin(ang)*r,40,MAP_H*TILE-40);
  // Police car
  const pc=new Car(x,y,pick(['#1e3a8a','#152c6b']),'police');
  pc.aiState='chase'; pc.isParked=false; pc.sirenOn=true;
  S.cars.push(pc);
  // Officer on foot
  const o=new Officer(x+rnd(-30,30),y+rnd(-30,30));
  o.chasing=true; o.aiState='chase';
  S.officers.push(o);
  if(S.officers.length>S.wantedLevel*4+4)
    S.officers=S.officers.filter((_,i)=>i>S.officers.length-S.wantedLevel*4-4);
}

function spawnCarNearPlayer(type){
  if(S.spawnCooldown>0){notify(`‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${S.spawnCooldown.toFixed(1)}—Å`,800);return;}
  const p=S.player;
  const ang=(p.inCar?p.inCar.angle:p.angle)+PI/2;
  const r=55;
  const x=clamp((p.inCar?p.inCar.x:p.x)+cos(ang)*r,20,MAP_W*TILE-20);
  const y=clamp((p.inCar?p.inCar.y:p.y)+sin(ang)*r,20,MAP_H*TILE-20);
  const c=new Car(x,y,pick(CAR_COLORS),type);
  c.angle=p.inCar?p.inCar.angle:p.angle;
  c.isParked=true; c.aiState='parked';
  S.cars.push(c);
  S.spawnCooldown=3;
  notify('üöó –ó–∞—Å–ø–∞–≤–Ω–µ–Ω '+carName(c)+'!',1500);
}

// ‚îÄ‚îÄ Collision ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function solidAt(wx,wy){
  const tx=floor(wx/TILE),ty=floor(wy/TILE);
  if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) return true;
  const t=S.world.map[ty][tx];
  return t===BUILDING||t===WATER;
}
function carSolid(wx,wy,car){
  const pts=[[-car.w/2,-car.h/2],[car.w/2,-car.h/2],[-car.w/2,car.h/2],[car.w/2,car.h/2]];
  for(const[ox,oy] of pts){
    const rx=wx+ox*cos(car.angle)-oy*sin(car.angle);
    const ry=wy+ox*sin(car.angle)+oy*cos(car.angle);
    if(solidAt(rx,ry)) return true;
  }
  return false;
}

function nearestCar(){
  const p=S.player;
  let best=null,bd=9999;
  for(const c of S.cars){
    if(c.driver) continue;
    const d=dst(p.x,p.y,c.x,c.y);
    if(d<bd){bd=d;best=c;}
  }
  return best;
}

// ‚îÄ‚îÄ Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  const ctx=S.ctx,W=S.W,H=S.H;
  const cx=S.cam.x,cy=S.cam.y;
  // Night overlay
  const isNight=S.dayTime<6||S.dayTime>20;
  const nightAlpha=isNight?0.45:max(0,(abs(S.dayTime-13)-6)/4*0.3);

  ctx.clearRect(0,0,W,H);
  ctx.save();
  ctx.translate(-cx,-cy);

  const tx0=max(0,floor(cx/TILE)-1);
  const ty0=max(0,floor(cy/TILE)-1);
  const tx1=min(MAP_W,tx0+ceil(W/TILE)+2);
  const ty1=min(MAP_H,ty0+ceil(H/TILE)+2);

  // ‚îÄ‚îÄ Tiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(let ty=ty0;ty<ty1;ty++){
    for(let tx=tx0;tx<tx1;tx++){
      const tile=S.world.map[ty][tx];
      const px=tx*TILE, py=ty*TILE;
      switch(tile){
        case ROAD:
          ctx.fillStyle='#454545';
          ctx.fillRect(px,py,TILE,TILE);
          break;
        case SIDEWALK:
          ctx.fillStyle='#8a8a8a';
          ctx.fillRect(px,py,TILE,TILE);
          // Curb line
          ctx.fillStyle='rgba(200,200,200,.15)';
          ctx.fillRect(px,py,TILE,1); ctx.fillRect(px,py,1,TILE);
          break;
        case BUILDING:{
          const bc=S.world.bColors[ty][tx]||'#667';
          ctx.fillStyle=bc;
          ctx.fillRect(px,py,TILE,TILE);
          // Roof shadow
          ctx.fillStyle='rgba(0,0,0,0.2)';
          ctx.fillRect(px+1,py+1,TILE-2,TILE-2);
          // Windows ‚Äî stable hash-based
          const wCols=3,wRows=3;
          for(let wr=0;wr<wRows;wr++){
            for(let wc=0;wc<wCols;wc++){
              const wx2=px+5+wc*(TILE-10)/(wCols);
              const wy2=py+5+wr*(TILE-10)/(wRows);
              const lit=hash(tx*31+wc*7,ty*37+wr*11)>0.4;
              if(isNight){
                ctx.fillStyle=lit?'rgba(255,240,160,0.85)':'rgba(0,0,0,0.5)';
              } else {
                ctx.fillStyle=lit?'rgba(160,200,255,0.55)':'rgba(0,0,0,0.25)';
              }
              ctx.fillRect(wx2,wy2,5,5);
            }
          }
          // Rooftop detail
          ctx.fillStyle='rgba(0,0,0,0.1)';
          ctx.fillRect(px+2,py+2,4,TILE-4);
          break;
        }
        case PARK:
          ctx.fillStyle='#2a6e2a';
          ctx.fillRect(px,py,TILE,TILE);
          ctx.fillStyle='#236023';
          ctx.fillRect(px+4,py+4,TILE-8,TILE-8);
          // Trees dots
          if(hash(tx*5,ty*5)>0.5){
            ctx.fillStyle='#1a5a1a';
            ctx.beginPath();
            ctx.arc(px+TILE/2,py+TILE/2,8,0,PI*2);
            ctx.fill();
          }
          break;
        case WATER:
          ctx.fillStyle='#1a4a6a';
          ctx.fillRect(px,py,TILE,TILE);
          ctx.fillStyle='rgba(30,100,160,0.4)';
          ctx.fillRect(px+2,py+2,TILE-4,TILE-4);
          // Ripple
          if((S.frameCount+tx+ty)%8<4){
            ctx.strokeStyle='rgba(80,150,220,0.25)';
            ctx.lineWidth=1;
            ctx.beginPath();
            ctx.arc(px+TILE/2+sin(S.gameTime+tx)*6,py+TILE/2,6,0,PI*2);
            ctx.stroke();
          }
          break;
        default:
          ctx.fillStyle='#333';
          ctx.fillRect(px,py,TILE,TILE);
      }
    }
  }

  // ‚îÄ‚îÄ Road markings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ctx.setLineDash([10,10]);
  ctx.lineWidth=1.2;
  ctx.strokeStyle='rgba(255,240,0,0.35)';
  for(let ty=ty0;ty<ty1;ty++){
    for(let tx=tx0;tx<tx1;tx++){
      if(S.world.map[ty][tx]!==ROAD) continue;
      const px=tx*TILE, py=ty*TILE;
      const isVert=S.world.roadX.includes(tx);
      ctx.beginPath();
      if(isVert){ ctx.moveTo(px+TILE/2,py); ctx.lineTo(px+TILE/2,py+TILE); }
      else       { ctx.moveTo(px,py+TILE/2); ctx.lineTo(px+TILE,py+TILE/2); }
      ctx.stroke();
    }
  }
  ctx.setLineDash([]);

  // ‚îÄ‚îÄ Skid marks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // (dynamic, not stored per tile ‚Äî just visual flicker)
  if(S.player.inCar&&abs(S.player.inCar.speed)>80&&S.keys['Space']){
    const c=S.player.inCar;
    ctx.strokeStyle='rgba(0,0,0,0.35)';
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(c.x-cos(c.angle)*20,c.y-sin(c.angle)*20);
    ctx.lineTo(c.x-cos(c.angle)*40,c.y-sin(c.angle)*40);
    ctx.stroke();
  }

  // ‚îÄ‚îÄ Dead NPCs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const n of S.npcs){
    if(n.alive) continue;
    ctx.save();
    ctx.translate(n.x,n.y);
    ctx.fillStyle='rgba(180,0,0,0.7)';
    ctx.beginPath(); ctx.ellipse(0,0,10,6,0,0,PI*2); ctx.fill();
    ctx.restore();
  }

  // ‚îÄ‚îÄ Parked cars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const c of S.cars) if(c.isParked&&c.driver!==S.player) drawCar(ctx,c);
  // ‚îÄ‚îÄ Moving cars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const c of S.cars) if(!c.isParked&&c.driver!==S.player) drawCar(ctx,c);
  // ‚îÄ‚îÄ Player car ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(S.player.inCar) drawCar(ctx,S.player.inCar);

  // ‚îÄ‚îÄ NPCs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  for(const n of S.npcs) if(n.alive) drawHuman(ctx,n);
  for(const o of S.officers) if(o.alive) drawHuman(ctx,o);

  // ‚îÄ‚îÄ Player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!S.player.inCar) drawPlayer(ctx,S.player);

  // ‚îÄ‚îÄ Enter-car prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(!S.player.inCar){
    const nc=nearestCar();
    if(nc&&dst(S.player.x,S.player.y,nc.x,nc.y)<55){
      ctx.save();
      ctx.translate(nc.x,nc.y);
      ctx.fillStyle='rgba(0,0,0,0.7)';
      ctx.beginPath(); ctx.roundRect(-28,-26,56,18,5); ctx.fill();
      ctx.fillStyle='#fff'; ctx.font='bold 10px Segoe UI';
      ctx.textAlign='center'; ctx.fillText('[F] –í–æ–π—Ç–∏ –≤ –º–∞—à–∏–Ω—É',0,-14);
      ctx.restore();
    }
  }

  // ‚îÄ‚îÄ Night overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if(nightAlpha>0.05){
    ctx.fillStyle=`rgba(0,10,30,${nightAlpha})`;
    ctx.fillRect(cx,cy,W,H);
    // Headlights cones
    if(S.player.inCar){
      const c=S.player.inCar;
      const grd=ctx.createRadialGradient(c.x,c.y,5,
        c.x+cos(c.angle)*60,c.y+sin(c.angle)*60,90);
      grd.addColorStop(0,'rgba(255,255,200,0.18)');
      grd.addColorStop(1,'transparent');
      ctx.fillStyle=grd;
      ctx.beginPath();ctx.arc(c.x+cos(c.angle)*60,c.y+sin(c.angle)*60,90,0,PI*2);ctx.fill();
    }
  }

  ctx.restore();
}

function drawCar(ctx,car){
  ctx.save();
  ctx.translate(car.x,car.y);
  ctx.rotate(car.angle);
  const w=car.w,h=car.h;
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.28)';
  ctx.fillRect(-w/2+2,h/2,w,3);
  // Body
  ctx.fillStyle=car.color;
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(-w/2,-h/2,w,h,4);
  else ctx.rect(-w/2,-h/2,w,h);
  ctx.fill();
  // Stripe (for variety)
  const dark=darken(car.color,0.2);
  ctx.fillStyle=dark;
  ctx.fillRect(-w/2+3,-2,w-6,4);
  // Cabin
  ctx.fillStyle=darken(car.color,0.3);
  const cw=w*0.5,ch=h*0.55;
  if(ctx.roundRect) ctx.beginPath(),ctx.roundRect(-cw/2,-ch/2,cw,ch,3),ctx.fill();
  else ctx.fillRect(-cw/2,-ch/2,cw,ch);
  // Windshield
  ctx.fillStyle='rgba(100,180,255,0.55)';
  ctx.fillRect(w/2-9,-h/2+2,6,h-4);
  ctx.fillStyle='rgba(100,180,255,0.35)';
  ctx.fillRect(-w/2+3,-h/2+2,6,h-4);
  // Headlights
  ctx.fillStyle='rgba(255,255,180,0.9)';
  ctx.fillRect(w/2-2,-h/2+2,2,3);
  ctx.fillRect(w/2-2,h/2-5,2,3);
  // Tail
  ctx.fillStyle=car.brakeLight?'rgba(255,0,0,0.95)':'rgba(200,30,30,0.7)';
  ctx.fillRect(-w/2,-h/2+2,2,3);
  ctx.fillRect(-w/2,h/2-5,2,3);
  // Wheels
  ctx.fillStyle='#111';
  for(const[wx2,wy2] of [[w/2-8,-h/2-2],[w/2-8,h/2-1],[-w/2+2,-h/2-2],[-w/2+2,h/2-1]]){
    ctx.fillRect(wx2,wy2,6,3);
  }
  // Police extras
  if(car.isPolice){
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.font='bold 5px Arial';ctx.textAlign='center';
    ctx.fillText('POLICE',0,h/2+2);
    // Siren lights
    if(car.sirenOn||S.wantedLevel>0){
      ctx.fillStyle=S.frameCount%14<7?'#f00':'#00f';
      ctx.fillRect(-4,-h/2-4,4,3);
      ctx.fillStyle=S.frameCount%14<7?'#00f':'#f00';
      ctx.fillRect(1,-h/2-4,4,3);
    }
  }
  // Type label
  if(car.type==='truck'){
    ctx.fillStyle='rgba(255,255,255,0.25)';
    ctx.font='5px Arial'; ctx.textAlign='center';
    ctx.fillText('TRUCK',0,1);
  }
  if(car.type==='sports'){
    // Low spoiler
    ctx.fillStyle=darken(car.color,0.1);
    ctx.fillRect(-w/2-2,h/2-1,4,2);
  }
  ctx.restore();
}

function drawHuman(ctx,n){
  ctx.save();
  ctx.translate(n.x,n.y);
  const ang=atan2(n.dir.y||0,n.dir.x||1)+PI/2;
  ctx.rotate(ang);
  const lo=n.animFrame<2?2:-2;
  // Legs
  ctx.fillStyle=n.pantsColor;
  ctx.fillRect(-3,1,2,5+lo); ctx.fillRect(1,1,2,5-lo);
  // Arms (swing)
  ctx.fillStyle=n.skinColor;
  ctx.fillRect(-6,-3,2,4+lo); ctx.fillRect(4,-3,2,4-lo);
  // Body
  ctx.fillStyle=n.shirtColor;
  if(ctx.roundRect) ctx.beginPath(),ctx.roundRect(-4,-5,8,8,2),ctx.fill();
  else ctx.fillRect(-4,-5,8,8);
  // Head
  ctx.fillStyle=n.skinColor;
  ctx.beginPath(); ctx.arc(0,-9,4,0,PI*2); ctx.fill();
  // Police hat
  if(n.isPolice){
    ctx.fillStyle='#1a3a6b';
    ctx.fillRect(-5,-14,10,3);
    ctx.fillStyle='#ffd700';
    ctx.font='bold 5px Arial'; ctx.textAlign='center';
    ctx.fillText('üëÆ',0,-20);
  }
  ctx.restore();
}

function drawPlayer(ctx,p){
  ctx.save();
  ctx.translate(p.x,p.y);
  ctx.rotate(p.angle+PI/2);
  const lo=p.animFrame<2?3:-3;
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.22)';
  ctx.beginPath(); ctx.ellipse(0,3,7,3,0,0,PI*2); ctx.fill();
  // Legs
  ctx.fillStyle=p.pantsColor;
  ctx.fillRect(-4,2,3,7+lo); ctx.fillRect(1,2,3,7-lo);
  // Arms
  ctx.fillStyle=p.skinColor;
  ctx.fillRect(-7,-4,3,5+lo); ctx.fillRect(4,-4,3,5-lo);
  // Body
  ctx.fillStyle=p.shirtColor;
  if(ctx.roundRect) ctx.beginPath(),ctx.roundRect(-5,-7,10,11,2),ctx.fill();
  else ctx.fillRect(-5,-7,10,11);
  // Head
  ctx.fillStyle=p.skinColor;
  ctx.beginPath(); ctx.arc(0,-11,5,0,PI*2); ctx.fill();
  // Eyes
  ctx.fillStyle='#222';
  ctx.fillRect(-2,-13,1.5,1.5); ctx.fillRect(1,-13,1.5,1.5);
  // Arrow "YOU"
  ctx.fillStyle='rgba(255,255,255,0.9)';
  ctx.font='bold 8px Arial'; ctx.textAlign='center';
  ctx.fillText('‚ñº –í–´',0,-20);
  ctx.restore();
}

// ‚îÄ‚îÄ HUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawHUD(){
  const hud=S.hud; if(!hud) return;
  const p=S.player;
  const night=S.dayTime<6||S.dayTime>20;
  const hour=floor(S.dayTime),min2=floor((S.dayTime%1)*60);
  const timeStr=`${hour.toString().padStart(2,'0')}:${min2.toString().padStart(2,'0')}`;
  const timeEmoji=night?'üåô':S.dayTime<12?'üåÖ':'‚òÄÔ∏è';

  const stars=Array.from({length:5},(_,i)=>i<S.wantedLevel?'‚≠ê':'‚òÜ').join('');

  let html=`
  <!-- Health + money -->
  <div style="position:absolute;top:10px;left:10px;display:flex;flex-direction:column;gap:5px;pointer-events:none;">
    <div style="background:rgba(0,0,0,.78);border-radius:9px;padding:6px 12px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:13px;">‚ù§Ô∏è</span>
      <div style="width:90px;height:7px;background:rgba(255,255,255,.15);border-radius:4px;overflow:hidden;">
        <div style="width:${p.health}%;height:100%;background:${p.health>60?'#2ecc71':p.health>30?'#f1c40f':'#e74c3c'};border-radius:4px;transition:width .4s;"></div>
      </div>
      <span style="color:#fff;font-size:11px;">${p.health}</span>
    </div>
    <div style="background:rgba(0,0,0,.78);border-radius:9px;padding:5px 12px;color:#f1c40f;font-size:13px;font-weight:700;">üí∞ $${p.money.toLocaleString()}</div>
    <div style="background:rgba(0,0,0,.78);border-radius:9px;padding:5px 12px;color:#95a5a6;font-size:11px;">üèÜ ${S.score.toLocaleString()} pts</div>
    <div style="background:rgba(0,0,0,.78);border-radius:9px;padding:5px 12px;color:#aaa;font-size:11px;">${timeEmoji} ${timeStr}</div>
  </div>

  <!-- Wanted -->
  <div style="position:absolute;top:10px;right:10px;background:rgba(0,0,0,.78);border-radius:9px;padding:8px 14px;text-align:right;pointer-events:none;">
    <div style="color:#aaa;font-size:9px;letter-spacing:1px;margin-bottom:3px;">–†–û–ó–´–°–ö</div>
    <div style="font-size:17px;letter-spacing:3px;color:${S.wantedLevel===0?'#444':S.wantedLevel<3?'#f1c40f':'#e74c3c'};">${stars}</div>
    ${S.wantedLevel>0?`<div style="color:#e74c3c;font-size:9px;margin-top:3px;animation:blink 0.8s ease infinite;">‚ö†Ô∏è –ü–æ–ª–∏—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–∞!</div>`:''}
  </div>`;

  // Speedometer (driving)
  if(p.inCar){
    const spd=abs(floor(p.inCar.speed));
    const gear=spd<2?'P':p.inCar.speed<0?'R':'D';
    html+=`<div style="position:absolute;bottom:50px;left:10px;background:rgba(0,0,0,.85);border-radius:14px;padding:10px 18px;text-align:center;pointer-events:none;">
      <div style="color:#fff;font-size:30px;font-weight:200;line-height:1;">${spd}</div>
      <div style="color:#888;font-size:8px;letter-spacing:1px;">–ö–ú/–ß</div>
      <div style="color:${gear==='R'?'#e74c3c':gear==='P'?'#f1c40f':'#2ecc71'};font-size:13px;font-weight:700;margin-top:2px;">${gear}</div>
      <div style="color:#666;font-size:9px;margin-top:1px;">${carName(p.inCar)}</div>
    </div>`;
  }

  // Notifications
  if(S.notifs.length>0){
    html+=`<div style="position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;gap:5px;align-items:center;pointer-events:none;">`;
    S.notifs.slice(-4).forEach(n=>{
      const op=min(1,n.t*2);
      html+=`<div style="background:rgba(0,0,0,.87);border-radius:10px;padding:8px 20px;color:#fff;font-size:12.5px;opacity:${op};white-space:nowrap;border:1px solid rgba(255,255,255,.1);">${n.msg}</div>`;
    });
    html+='</div>';
  }

  // Controls (collapsed)
  const inCar=!!p.inCar;
  html+=`<div style="position:absolute;top:42%;right:10px;background:rgba(0,0,0,.65);border-radius:9px;padding:8px 12px;font-size:9.5px;color:rgba(255,255,255,.6);line-height:1.9;pointer-events:none;text-align:right;">
    <div>WASD ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ</div>
    <div>F ‚Äî ${inCar?'–≤—ã–π—Ç–∏ –∏–∑ –º–∞—à–∏–Ω—ã':'–≤–æ–π—Ç–∏ –≤ –º–∞—à–∏–Ω—É'}</div>
    <div>G ‚Äî —Å–ø–∞–≤–Ω –∞–≤—Ç–æ</div>
    <div>T ‚Äî —Å–ø–æ—Ä—Ç–∫–∞—Ä</div>
    ${inCar?'<div>Space ‚Äî —Ç–æ—Ä–º–æ–∑</div>':'<div>Shift ‚Äî –±–µ–≥</div>'}
  </div>`;

  // NPC / car counter
  html+=`<div style="position:absolute;bottom:50px;right:155px;background:rgba(0,0,0,.6);border-radius:8px;padding:5px 10px;font-size:10px;color:#888;pointer-events:none;">
    üöó ${S.cars.length}  üë• ${S.npcs.filter(n=>n.alive).length}  üëÆ ${S.officers.filter(o=>o.alive).length}
  </div>`;

  hud.innerHTML=html;
}

// ‚îÄ‚îÄ Minimap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawMinimap(){
  const mm=S.mmCanvas; if(!mm) return;
  const ctx=mm.getContext('2d');
  const SZ=140, SC=0.11;
  ctx.clearRect(0,0,SZ,SZ);

  // Clip circle
  ctx.save();
  ctx.beginPath(); ctx.arc(SZ/2,SZ/2,SZ/2,0,PI*2); ctx.clip();

  // Background
  ctx.fillStyle='#222';
  ctx.fillRect(0,0,SZ,SZ);

  const p=S.player;
  const px=p.inCar?p.inCar.x:p.x, py=p.inCar?p.inCar.y:p.y;
  const ox=SZ/2-px*SC, oy=SZ/2-py*SC;

  // Draw tiles
  for(let ty=0;ty<MAP_H;ty++){
    for(let tx=0;tx<MAP_W;tx++){
      const sx=tx*TILE*SC+ox, sy=ty*TILE*SC+oy;
      const sw=TILE*SC+0.5;
      if(sx<-sw||sy<-sw||sx>SZ||sy>SZ) continue;
      const tile=S.world.map[ty][tx];
      ctx.fillStyle=tile===ROAD?'#666':tile===SIDEWALK?'#999':tile===BUILDING?(S.world.bColors[ty][tx]||'#445'):tile===PARK?'#2a6a2a':'#1a3a5a';
      ctx.fillRect(sx,sy,sw,sw);
    }
  }

  // Cars
  for(const c of S.cars){
    const sx=c.x*SC+ox, sy=c.y*SC+oy;
    ctx.fillStyle=c.isPolice?'#3af':'red';
    ctx.fillRect(sx-1.5,sy-1.5,3,3);
  }

  // NPCs
  ctx.fillStyle='rgba(255,220,0,0.7)';
  for(const n of S.npcs) if(n.alive){
    ctx.fillRect(n.x*SC+ox-0.8,n.y*SC+oy-0.8,1.6,1.6);
  }

  // Officers (blue)
  ctx.fillStyle='#1af';
  for(const o of S.officers) if(o.alive){
    ctx.beginPath(); ctx.arc(o.x*SC+ox,o.y*SC+oy,2,0,PI*2); ctx.fill();
  }

  // Player dot
  ctx.fillStyle='#e74c3c';
  ctx.beginPath(); ctx.arc(SZ/2,SZ/2,4.5,0,PI*2); ctx.fill();
  ctx.strokeStyle='#fff'; ctx.lineWidth=1.5; ctx.stroke();

  ctx.restore();

  // Compass
  ctx.fillStyle='rgba(255,255,255,0.8)';
  ctx.font='bold 9px Arial'; ctx.textAlign='center';
  ctx.fillText('–°',SZ/2,8);
}

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function carName(c){
  return{sedan:'Sedan',sports:'Sports',suv:'SUV',truck:'Truck',police:'Police'}[c.type]||'Car';
}
function darken(hex,t){
  try{
    hex=hex.replace('#','');
    const r=parseInt(hex.slice(0,2),16),g=parseInt(hex.slice(2,4),16),b=parseInt(hex.slice(4,6),16);
    return`rgb(${floor(r*(1-t))},${floor(g*(1-t))},${floor(b*(1-t))})`;
  }catch(e){return hex;}
}
function ceil(x){return Math.ceil(x);}
function notify(msg,ms=2000){S.notifs.push({msg,t:ms/1000});}

// ‚îÄ‚îÄ Public ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stop(){
  S.running=false;
  for(const[el,ev,fn] of S._listeners) el.removeEventListener(ev,fn);
  S._listeners=[];
}

return{init,stop,spawnCar:spawnCarNearPlayer,clearWanted,state:S,_started:false};
})();

</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GTA 6 OPEN/CLOSE PATCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
(function(){
  var _orig = window.openApp;
  window.openApp = function(app) {
    if (app === 'gta6') {
      var w = document.getElementById('win-gta6');
      var root = document.getElementById('gta6-root');
      if (w) {
        w.style.display = 'flex';
        if (typeof bringFront === 'function') bringFront('win-gta6');
        var tb = document.getElementById('tb-gta6');
        if (tb) tb.classList.add('running','active-win');
        if (root && !window._gta6started) {
          GTA6.init(root);
          window._gta6started = true;
        }
      }
      return;
    }
    if (_orig) _orig.call(window, app);
  };
  var _origClose = window.closeWin;
  window.closeWin = function(app) {
    if (app === 'gta6') { gta6Close(); return; }
    if (_origClose) _origClose.call(window, app);
  };
  window.gta6Close = function() {
    var w = document.getElementById('win-gta6');
    if (w) w.style.display = 'none';
    var tb = document.getElementById('tb-gta6');
    if (tb) tb.classList.remove('running','active-win');
    if (window.GTA6 && window._gta6started) { GTA6.stop(); window._gta6started = false; }
  };
  var _origTb = window.tbClick;
  window.tbClick = function(app) {
    if (app === 'gta6') {
      var w = document.getElementById('win-gta6');
      if (!w) return;
      if (!w.style.display || w.style.display === 'none') openApp('gta6');
      else if (typeof bringFront === 'function') bringFront('win-gta6');
      return;
    }
    if (_origTb) _origTb.call(window, app);
  };
})();
</script>

</body>
</html>
